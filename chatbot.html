<!DOCTYPE html>
<html>
<head>
    <title>Voiceflow Chatbot Tester v4 - API Direct</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0;
            padding: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 350px 1fr 400px;
            gap: 20px;
            height: 90vh;
        }
        .panel { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .chatbot-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 8px 0;
            width: 100%;
            font-size: 14px;
            font-weight: bold;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.green { background: #28a745; }
        button.gray { background: #6c757d; }
        button.red { background: #dc3545; }
        .status { 
            padding: 12px; 
            border-radius: 4px; 
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .section {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            background: #f8f9fa;
        }
        .section h4 {
            margin: 0 0 15px 0;
            color: #495057;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin: 8px 0;
            box-sizing: border-box;
            font-family: inherit;
        }
        textarea {
            resize: vertical;
            font-family: monospace;
            font-size: 13px;
        }
        label {
            display: block;
            margin: 8px 0 4px 0;
            font-weight: bold;
            font-size: 13px;
        }
        .questions-display {
            background: #e9ecef;
            border: 1px solid #adb5bd;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }
        .question-item {
            padding: 6px;
            margin: 3px 0;
            border-radius: 3px;
            background: white;
        }
        .question-item.current {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            font-weight: bold;
        }
        .question-item.completed {
            background: #d4edda;
            border-left: 3px solid #28a745;
        }
        .transcript {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            height: 500px;
            overflow-y: auto;
            font-size: 13px;
            margin: 15px 0;
        }
        .qa-pair {
            margin: 15px 0;
            padding: 12px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .qa-question {
            background: #007bff;
            color: white;
            padding: 10px;
            border-radius: 6px 6px 0 0;
            font-weight: bold;
        }
        .qa-answer {
            background: #e9ecef;
            color: #333;
            padding: 12px;
            border-radius: 0 0 6px 6px;
            margin-top: 2px;
            line-height: 1.6;
        }
        .qa-waiting {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 0 0 6px 6px;
            margin-top: 2px;
            font-style: italic;
        }
        .message.system {
            background: #d1ecf1;
            color: #0c5460;
            padding: 8px;
            border-radius: 4px;
            margin: 8px 0;
            text-align: center;
            font-style: italic;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        .stat-box {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 11px;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel: Controls -->
        <div class="panel">
            <h2>ü§ñ Chatbot Tester v4</h2>
            <div style="background: #e7f3ff; padding: 8px; border-radius: 4px; margin-bottom: 10px; font-size: 12px;">
                ‚ú® NEW: Direct API communication for 100% reliable capture
            </div>
            
            <div class="section">
                <h4>üìù Load Questions</h4>
                
                <label>Manual Questions:</label>
                <textarea id="questionTextArea" rows="8">who is the department head
who is the DAF
how can i create a budget?
how do i request a waiver
how do i request a proposal waiver
how do i request a waiver of search?
does the department still do waivers of search
where is Gabby Hoyte's office
who does Gabby Hoyte support?
who is the development officer?
who supports sertac karaman?</textarea>
                <button onclick="loadFromTextArea()" class="green">üìù Load These Questions</button>
                
                <label>Google Sheet ID (optional):</label>
                <input type="text" id="googleSheetId" placeholder="Enter Google Sheet ID" value="1flnWLAXZGoTpDjkRMuuD3LvyphYIij0gruCu_4x__gQ">
                <button onclick="tryGoogleSheets()" id="googleBtn">üì• Load from Google Sheets</button>
                <div style="font-size: 11px; color: #6c757d; margin: 5px 0;" id="googleStatus">Optional: Load from Google Sheets</div>
            </div>

            <div class="section">
                <h4>‚öôÔ∏è API Configuration</h4>
                <label>Project ID:</label>
                <input type="text" id="projectId" value="66de313d6a0d94e1bd71c5ce" readonly>
                <label>User ID:</label>
                <input type="text" id="userId" value="mit-tester" placeholder="Enter user ID">
                <div style="font-size: 11px; color: #6c757d; margin: 5px 0;">API will send questions directly to Voiceflow</div>
            </div>

            <div class="stats">
                <div class="stat-box">
                    <div class="stat-number" id="statQuestions">0</div>
                    <div class="stat-label">Questions Loaded</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="statCompleted">0</div>
                    <div class="stat-label">Completed</div>
                </div>
            </div>

            <div class="status" id="mainStatus">Ready - load questions above</div>

            <button onclick="loadChatbot()" id="loadChatBtn">üîó Load Chatbot (Visual Only)</button>
            <button onclick="startTest()" id="startBtn" disabled>‚ñ∂Ô∏è Start Automated Test</button>
            <button onclick="stopTest()" id="stopBtn" disabled class="red">‚èπÔ∏è Stop Test</button>

            <div class="questions-display" id="questionsDisplay">
                <div style="text-align: center; color: #6c757d;">Load questions above to see them here</div>
            </div>
        </div>

        <!-- Middle Panel: Chatbot (Visual Reference Only) -->
        <div class="chatbot-panel">
            <iframe id="chatIframe" src="about:blank"></iframe>
        </div>

        <!-- Right Panel: Transcript -->
        <div class="panel">
            <h3>üí¨ Live Q&A Transcript</h3>
            <div class="transcript" id="transcript">
                <div class="message system">Q&A pairs will appear here during testing</div>
            </div>
            <button onclick="clearTranscript()">üóëÔ∏è Clear Transcript</button>
            <button onclick="copyToClipboard()" class="green">üìã Copy Transcript</button>
            <button onclick="exportToCSV()" class="gray">üìä Export CSV</button>
        </div>
    </div>

    <script>
        let questionsList = [];
        let currentQuestionIndex = 0;
        let testRunning = false;
        let qaResults = [];

        // Voiceflow API configuration
        const VOICEFLOW_API_URL = 'https://general-runtime.voiceflow.com';
        const VOICEFLOW_PROJECT_ID = '66de313d6a0d94e1bd71c5ce';

        function updateStats() {
            document.getElementById('statQuestions').textContent = questionsList.length;
            document.getElementById('statCompleted').textContent = qaResults.filter(qa => qa.answer !== 'WAITING').length;
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('mainStatus');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function addSystemMessage(message) {
            const transcript = document.getElementById('transcript');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.textContent = message;
            transcript.appendChild(messageDiv);
            transcript.scrollTop = transcript.scrollHeight;
        }

        function loadFromTextArea() {
            const textarea = document.getElementById('questionTextArea');
            const text = textarea.value;
            const questions = text.split('\n')
                .map(q => q.trim())
                .filter(q => q.length > 0);
            
            if (questions.length === 0) {
                updateStatus('No questions found in text area', 'error');
                return;
            }

            questionsList = questions;
            updateStatus(`Loaded ${questionsList.length} questions`, 'success');
            addSystemMessage(`‚úÖ Loaded ${questionsList.length} questions from text area`);
            displayQuestions();
            updateStats();
            checkReadyToTest();
        }

        function displayQuestions() {
            const display = document.getElementById('questionsDisplay');
            display.innerHTML = '';
            
            questionsList.forEach((q, index) => {
                const div = document.createElement('div');
                div.className = 'question-item';
                div.id = `question-${index}`;
                div.textContent = `${index + 1}. ${q}`;
                display.appendChild(div);
            });
        }

        async function tryGoogleSheets() {
            const btn = document.getElementById('googleBtn');
            const status = document.getElementById('googleStatus');
            const sheetId = document.getElementById('googleSheetId').value.trim();

            if (!sheetId) {
                updateStatus('Please enter a Google Sheet ID', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = '‚è≥ Loading...';
            status.textContent = 'Attempting to fetch...';

            try {
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0`;
                
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 8000);
                
                const response = await fetch(url, {
                    signal: controller.signal,
                    mode: 'cors'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} - Sheet may not be published`);
                }

                const csvText = await response.text();
                const lines = csvText.split('\n');
                const questions = lines
                    .slice(1)
                    .map(line => line.split(',')[0])
                    .filter(q => q && q.trim())
                    .map(q => q.replace(/"/g, '').trim());

                if (questions.length === 0) {
                    throw new Error('No questions found in first column');
                }

                questionsList = questions;
                updateStatus(`Loaded ${questionsList.length} questions from Google Sheets`, 'success');
                addSystemMessage(`‚úÖ Loaded ${questionsList.length} questions from Google Sheets`);
                status.textContent = `Success: ${questionsList.length} questions loaded`;
                displayQuestions();
                updateStats();
                checkReadyToTest();

            } catch (error) {
                let errorMsg = error.message;
                if (error.name === 'AbortError') {
                    errorMsg = 'Timed out - sheet may not be published';
                }
                
                updateStatus(`Google Sheets failed: ${errorMsg}`, 'error');
                status.textContent = `Failed: ${errorMsg}`;
            } finally {
                btn.textContent = 'üì• Load from Google Sheets';
                btn.disabled = false;
            }
        }

        function loadChatbot() {
            const iframe = document.getElementById('chatIframe');
            iframe.src = 'https://aeroastrovfbot.netlify.app/chatbot.html';
            
            updateStatus('Chatbot loaded (for visual reference)', 'info');
            addSystemMessage('üîó Chatbot loaded (visual only - test uses API directly)');
            checkReadyToTest();
        }

        function checkReadyToTest() {
            const startBtn = document.getElementById('startBtn');
            if (questionsList.length > 0) {
                startBtn.disabled = false;
                updateStatus('Ready to start testing!', 'success');
            }
        }

        async function startTest() {
            if (questionsList.length === 0) {
                updateStatus('Please load questions first', 'error');
                return;
            }

            currentQuestionIndex = 0;
            qaResults = [];
            testRunning = true;
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('loadChatBtn').disabled = true;
            
            updateStatus('Testing in progress...', 'warning');
            addSystemMessage(`üöÄ Starting API-based test with ${questionsList.length} questions`);
            updateStats();
            
            await sendNextQuestion();
        }

        async function sendNextQuestion() {
            if (!testRunning || currentQuestionIndex >= questionsList.length) {
                if (currentQuestionIndex >= questionsList.length) {
                    stopTest();
                    updateStatus('All questions completed!', 'success');
                    addSystemMessage('üéâ All questions completed!');
                }
                return;
            }

            const question = questionsList[currentQuestionIndex];
            const questionNum = currentQuestionIndex + 1;
            
            // Update question display
            document.querySelectorAll('.question-item').forEach(item => {
                item.classList.remove('current');
            });
            const currentItem = document.getElementById(`question-${currentQuestionIndex}`);
            if (currentItem) {
                currentItem.classList.add('current');
            }

            // Add to results as waiting
            qaResults.push({
                question: question,
                answer: 'WAITING',
                timestamp: new Date().toISOString()
            });

            updateTranscriptDisplay();
            
            console.log(`Sending Q${questionNum}: ${question}`);
            
            try {
                const startTime = Date.now();
                const userId = document.getElementById('userId').value || 'mit-tester';
                
                // Send question to Voiceflow API
                const response = await fetch(`${VOICEFLOW_API_URL}/state/user/${userId}/interact`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': VOICEFLOW_PROJECT_ID
                    },
                    body: JSON.stringify({
                        action: {
                            type: 'text',
                            payload: question
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`API returned ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const responseTime = Date.now() - startTime;
                
                console.log('API Response:', data);
                
                // Extract text from response
                let responseText = '';
                if (Array.isArray(data)) {
                    for (const trace of data) {
                        if (trace.type === 'text' && trace.payload && trace.payload.message) {
                            responseText += trace.payload.message + '\n\n';
                        } else if (trace.type === 'speak' && trace.payload && trace.payload.message) {
                            responseText += trace.payload.message + '\n\n';
                        }
                    }
                }
                
                responseText = responseText.trim() || 'No text response received';
                
                // Update the Q&A pair
                qaResults[qaResults.length - 1] = {
                    question: question,
                    answer: responseText,
                    timestamp: new Date().toISOString(),
                    responseTime: responseTime
                };

                updateTranscriptDisplay();
                updateStats();
                
                // Mark as completed
                if (currentItem) {
                    currentItem.classList.remove('current');
                    currentItem.classList.add('completed');
                }

            } catch (error) {
                console.error('Error:', error);
                qaResults[qaResults.length - 1].answer = `Error: ${error.message}`;
                updateTranscriptDisplay();
            }

            currentQuestionIndex++;
            
            // Continue to next question after 1 second
            if (testRunning) {
                setTimeout(sendNextQuestion, 1000);
            }
        }

        function stopTest() {
            testRunning = false;
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('loadChatBtn').disabled = false;
            
            updateStatus('Test stopped', 'info');
            addSystemMessage('‚èπÔ∏è Test stopped');
        }

        function updateTranscriptDisplay() {
            const transcript = document.getElementById('transcript');
            transcript.innerHTML = '';

            qaResults.forEach((qa, index) => {
                const qaDiv = document.createElement('div');
                qaDiv.className = 'qa-pair';
                
                const questionDiv = document.createElement('div');
                questionDiv.className = 'qa-question';
                questionDiv.textContent = `Q${index + 1}: ${qa.question}`;
                
                const answerDiv = document.createElement('div');
                if (qa.answer === 'WAITING') {
                    answerDiv.className = 'qa-waiting';
                    answerDiv.textContent = '‚è≥ Waiting for response...';
                } else {
                    answerDiv.className = 'qa-answer';
                    answerDiv.textContent = qa.answer;
                    
                    if (qa.responseTime) {
                        const timeInfo = document.createElement('div');
                        timeInfo.style.fontSize = '11px';
                        timeInfo.style.color = '#6c757d';
                        timeInfo.style.marginTop = '8px';
                        timeInfo.textContent = `‚è±Ô∏è Response time: ${(qa.responseTime / 1000).toFixed(1)}s`;
                        answerDiv.appendChild(timeInfo);
                    }
                }
                
                qaDiv.appendChild(questionDiv);
                qaDiv.appendChild(answerDiv);
                transcript.appendChild(qaDiv);
            });

            transcript.scrollTop = transcript.scrollHeight;
        }

        function clearTranscript() {
            qaResults = [];
            updateTranscriptDisplay();
            addSystemMessage('Transcript cleared');
            updateStats();
        }

        function copyToClipboard() {
            let text = '=== VOICEFLOW TEST RESULTS ===\n\n';
            
            qaResults.forEach((qa, index) => {
                text += `Q${index + 1}: ${qa.question}\n`;
                text += `A${index + 1}: ${qa.answer}\n`;
                if (qa.responseTime) {
                    text += `Time: ${(qa.responseTime / 1000).toFixed(1)}s\n`;
                }
                text += '\n---\n\n';
            });
            
            navigator.clipboard.writeText(text).then(() => {
                addSystemMessage('üìã Transcript copied to clipboard');
            });
        }

        function exportToCSV() {
            let csv = 'Question Number,Question,Answer,Response Time (seconds)\n';
            
            qaResults.forEach((qa, index) => {
                const question = qa.question.replace(/"/g, '""');
                const answer = qa.answer.replace(/"/g, '""');
                const time = qa.responseTime ? (qa.responseTime / 1000).toFixed(1) : 'N/A';
                csv += `${index + 1},"${question}","${answer}",${time}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `voiceflow-test-${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            
            addSystemMessage('üìä CSV exported successfully');
        }

        // Initialize
        window.addEventListener('load', () => {
            addSystemMessage('ü§ñ Chatbot Tester v4 Ready');
            addSystemMessage('‚ú® Using direct API calls for 100% reliable capture');
            addSystemMessage('Step 1: Load questions');
            addSystemMessage('Step 2: (Optional) Load chatbot for visual reference');
            addSystemMessage('Step 3: Start testing');
        });
    </script>
</body>
</html>
