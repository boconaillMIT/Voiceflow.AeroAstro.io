<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroAstro Chatbot</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .user-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        .user-info.visible {
            display: block;
        }
        .info-row {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 5px;
        }
        .info-label {
            font-weight: 600;
            color: #555;
        }
        .info-value {
            color: #333;
        }
        .chat-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 400px;
        }
        .debug-panel {
            background: #e8f4f8;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-size: 12px;
        }
        .debug-step {
            margin: 10px 0;
            padding: 8px;
            background: white;
            border-radius: 4px;
        }
        .success { border-left: 4px solid #27ae60; }
        .warning { border-left: 4px solid #f39c12; }
        .error { border-left: 4px solid #e74c3c; }
        .voiceflow-test {
            background: #fff3cd;
            border: 2px solid #f39c12;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-size: 14px;
        }
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        .logout-btn:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>AeroAstro Chatbot</h1>
        <p>AI Assistant for MIT's Department of Aeronautics and Astronautics</p>
    </div>

    <div class="user-info" id="user-info">
        <div class="info-row">
            <span class="info-label">Welcome:</span>
            <span class="info-value" id="display-name">Loading...</span>
        </div>
        <div class="info-row">
            <span class="info-label">Kerberos:</span>
            <span class="info-value" id="display-kerberos">Loading...</span>
        </div>
        <div class="info-row">
            <span class="info-label">Title:</span>
            <span class="info-value" id="display-title">Loading...</span>
        </div>
        <div class="info-row">
            <span class="info-label">Department:</span>
            <span class="info-value" id="display-department">Loading...</span>
        </div>
        <button class="logout-btn" onclick="logout()">Logout & Clear Session</button>
    </div>

    <div class="voiceflow-test">
        <h4>üß™ Voiceflow Variable Test</h4>
        <p>If variables are working, you should see a debug message in the chat after opening.</p>
        <p><strong>Expected:</strong> "DEBUG: Variables set - Name: [Real Name], Title: [Real Title]"</p>
        <p><strong>Key Fix:</strong> Session isolation and proper token validation</p>
    </div>

    <div class="debug-panel">
        <h3>üîç Debug Information</h3>
        <div id="debug-steps"></div>
    </div>

    <div class="chat-container">
        <p><b>Welcome! Starting your personalized AeroAstro AI assistant...</b></p>
        <div id="voiceflow-chat"></div>
    </div>

    <script type="text/javascript">
        let debugSteps = [];
        
        function addDebugStep(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            debugSteps.push({timestamp, message, type});
            
            const debugDiv = document.getElementById('debug-steps');
            debugDiv.innerHTML = debugSteps.map(step => 
                `<div class="debug-step ${step.type}">
                    <strong>[${step.timestamp}]</strong> ${step.message}
                </div>`
            ).join('');
            
            console.log(`[DEBUG ${timestamp}] ${message}`);
        }

        // Function to clear all stored authentication data
        function clearAuthData() {
            addDebugStep('Clearing all authentication data...', 'warning');
            
            // Clear OAuth-related localStorage items
            const keysToRemove = [
                'user_metadata',
                'pkce_verifier', 
                'pkce_state',
                'oauth_state',
                'access_token',
                'id_token',
                'refresh_token',
                'userID' // Also clear the generated userID to force regeneration
            ];
            
            keysToRemove.forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    addDebugStep(`Cleared localStorage key: ${key}`, 'info');
                }
            });
            
            // Clear sessionStorage as well
            sessionStorage.clear();
            addDebugStep('Cleared sessionStorage', 'info');
        }

        // Logout function
        function logout() {
            addDebugStep('User initiated logout', 'info');
            clearAuthData();
            window.location.href = 'login.html';
        }

        // Function to get URL parameters
        function getURLParameter(name) {
            return new URLSearchParams(window.location.search).get(name);
        }

        // Function to validate stored metadata freshness
        function validateStoredMetadata() {
            try {
                const stored = localStorage.getItem('user_metadata');
                if (!stored) return null;
                
                const metadata = JSON.parse(stored);
                addDebugStep(`Found stored metadata for user: ${metadata.kerberos || 'unknown'}`, 'info');
                
                // Check if token is expired
                if (metadata.raw && metadata.raw.exp) {
                    const expTime = metadata.raw.exp * 1000;
                    const now = Date.now();
                    const timeLeft = expTime - now;
                    
                    addDebugStep(`Token expires in: ${Math.round(timeLeft / 1000)} seconds`, 'info');
                    
                    if (timeLeft <= 0) {
                        addDebugStep('‚ùå Token has expired, clearing data', 'error');
                        clearAuthData();
                        return null;
                    }
                    
                    // Warn if token expires soon (less than 5 minutes)
                    if (timeLeft < 300000) {
                        addDebugStep('‚ö†Ô∏è Token expires in less than 5 minutes', 'warning');
                    }
                }
                
                // Validate required fields
                if (!metadata.kerberos) {
                    addDebugStep('‚ùå Stored metadata missing kerberos ID', 'error');
                    clearAuthData();
                    return null;
                }
                
                return metadata;
                
            } catch (e) {
                addDebugStep(`‚ùå Error validating stored metadata: ${e.message}`, 'error');
                clearAuthData();
                return null;
            }
        }

        // Enhanced user data collection with validation
        function collectUserData() {
            addDebugStep('Starting user data collection...', 'info');
            
            // First, check for fresh URL parameters (indicating new login)
            const urlData = {
                name: getURLParameter('name'),
                firstName: getURLParameter('firstName'),
                lastName: getURLParameter('lastName'),
                kerberos: getURLParameter('kerberos'),
                email: getURLParameter('email'),
                title: getURLParameter('title'),
                department: getURLParameter('department'),
                groups: getURLParameter('groups'),
                authenticated: getURLParameter('authenticated')
            };

            addDebugStep(`URL Parameters: ${JSON.stringify(urlData, null, 2)}`, 'info');

            // If we have fresh URL data, prioritize it and clear old stored data
            if (urlData.kerberos && urlData.authenticated === 'true') {
                addDebugStep('Fresh OAuth data detected from URL, clearing old stored data', 'info');
                
                // Check if this is a different user than what's stored
                const currentStored = localStorage.getItem('user_metadata');
                if (currentStored) {
                    try {
                        const parsed = JSON.parse(currentStored);
                        if (parsed.kerberos && parsed.kerberos !== urlData.kerberos) {
                            addDebugStep(`‚ö†Ô∏è User change detected: ${parsed.kerberos} ‚Üí ${urlData.kerberos}`, 'warning');
                            clearAuthData();
                        }
                    } catch (e) {
                        addDebugStep('Error parsing existing metadata, clearing', 'warning');
                        clearAuthData();
                    }
                }
            }

            // Get validated stored data
            const storedData = validateStoredMetadata();

            // Merge data (URL params take precedence for fresh logins)
            const userData = {
                name: urlData.name || (storedData && storedData.name) || 
                      (urlData.firstName && urlData.lastName ? `${urlData.firstName} ${urlData.lastName}` : '') ||
                      (storedData && storedData.firstName && storedData.lastName ? `${storedData.firstName} ${storedData.lastName}` : '') ||
                      'User',
                firstName: urlData.firstName || (storedData && storedData.firstName) || '',
                lastName: urlData.lastName || (storedData && storedData.lastName) || '',
                kerberos: urlData.kerberos || (storedData && storedData.kerberos) || '',
                email: urlData.email || (storedData && storedData.email) || '',
                title: urlData.title || (storedData && storedData.title) || '',
                department: urlData.department || (storedData && storedData.department) || '',
                groups: urlData.groups || (storedData && storedData.groups) || '',
                authenticated: (urlData.authenticated === 'true') || 
                              !!(storedData && storedData.kerberos),
                loginTime: (storedData && storedData.loginTime) || new Date().toISOString()
            };

            addDebugStep(`Final merged userData: ${JSON.stringify(userData, null, 2)}`, 'success');
            return userData;
        }

        // Update the display with user information
        function updateUserDisplay(userData) {
            addDebugStep('Updating user display...', 'info');
            
            if (userData.authenticated && userData.kerberos) {
                document.getElementById('display-name').textContent = userData.name || 'Not provided';
                document.getElementById('display-kerberos').textContent = userData.kerberos || 'Not provided';
                document.getElementById('display-title').textContent = userData.title || 'Not provided';
                document.getElementById('display-department').textContent = userData.department || 'Not provided';
                
                document.getElementById('user-info').classList.add('visible');
                addDebugStep('User info display updated successfully', 'success');
            } else {
                addDebugStep('No authenticated user data found', 'warning');
            }
        }

        // Generate userID for Voiceflow with user isolation
        function generateUserID(userData) {
            addDebugStep('Generating userID for Voiceflow...', 'info');
            
            if (userData.kerberos) {
                // Use kerberos-based ID with timestamp to ensure uniqueness across sessions
                const sessionId = Date.now().toString(36).substr(-4);
                const userID = `mit-${userData.kerberos}-${sessionId}`;
                addDebugStep(`Generated session-specific userID: ${userID}`, 'success');
                return userID;
            }
            
            // Fallback for users without kerberos
            let userID = sessionStorage.getItem('temp_userID'); // Use sessionStorage instead of localStorage
            if (!userID) {
                userID = 'user-' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('temp_userID', userID);
            }
            addDebugStep(`Fallback temporary userID: ${userID}`, 'warning');
            return userID;
        }

        // Load Voiceflow and set OAuth variables
        function loadVoiceflow(userID, userData) {
            addDebugStep('Starting Voiceflow load process...', 'info');
            
            (function(d, t) {
                var v = d.createElement(t), s = d.getElementsByTagName(t)[0];
                v.onload = function() {
                    addDebugStep('Voiceflow script loaded', 'success');
                    
                    // Load Voiceflow with user-specific session
                    window.voiceflow.chat.load({
                        verify: { projectID: '66de313d6a0d94e1bd71c5ce' },
                        url: 'https://general-runtime.voiceflow.com',
                        versionID: 'production',
                        userID: userID,
                        voice: {
                            url: "https://runtime-api.voiceflow.com"
                        }
                    });
                    
                    addDebugStep(`Voiceflow loaded for userID: ${userID}`, 'success');
                    
                    // Set Voiceflow variables with validated OAuth data
                    setTimeout(() => {
                        addDebugStep('Setting Voiceflow variables...', 'info');
                        
                        if (window.voiceflow && window.voiceflow.chat) {
                            const variablePayload = {
                                user_name: userData.name || '',
                                user_kerberos: userData.kerberos || '',
                                user_title: userData.title || '',
                                user_department: userData.department || '',
                                user_email: userData.email || '',
                                user_firstname: userData.firstName || '',
                                user_lastname: userData.lastName || '',
                                user_authenticated: userData.authenticated || false,
                                session_id: userID // Add session tracking
                            };
                            
                            addDebugStep(`Setting variables: ${JSON.stringify(variablePayload, null, 2)}`, 'info');
                            
                            try {
                                // Set variables
                                window.voiceflow.chat.interact({
                                    type: 'set',
                                    payload: variablePayload
                                });
                                addDebugStep('‚úÖ Variables set successfully!', 'success');
                                
                                // Send verification debug message
                                setTimeout(() => {
                                    const debugMessage = `DEBUG: Session started for ${variablePayload.user_name} (${variablePayload.user_kerberos}) - ${variablePayload.user_title} | Session: ${userID}`;
                                    window.voiceflow.chat.interact({
                                        type: 'text',
                                        payload: debugMessage
                                    });
                                    addDebugStep('‚úÖ Debug message sent to Voiceflow', 'success');
                                }, 1000);
                                
                                // Open chat
                                setTimeout(() => {
                                    window.voiceflow.chat.open();
                                    addDebugStep('‚úÖ Chat opened successfully!', 'success');
                                }, 2000);
                                
                            } catch (setError) {
                                addDebugStep(`‚ùå Error setting variables: ${setError.message}`, 'error');
                            }
                        } else {
                            addDebugStep('‚ùå window.voiceflow.chat not available', 'error');
                        }
                    }, 2000);
                };
                
                v.onerror = function() {
                    addDebugStep('‚ùå Error loading Voiceflow script', 'error');
                };
                
                v.src = "https://cdn.voiceflow.com/widget-next/bundle.mjs"; 
                v.type = "text/javascript"; 
                s.parentNode.insertBefore(v, s);
                
            })(document, 'script');
        }

        // Initialize the page
        function initializePage() {
            addDebugStep('Page initialization started', 'info');
            
            const userData = collectUserData();
            
            // Validate authentication
            if (!userData.authenticated || !userData.kerberos) {
                addDebugStep('‚ùå No valid authentication found, redirecting to login...', 'error');
                document.body.innerHTML = `
                    <div class="header">
                        <h1>Authentication Required</h1>
                        <p>Redirecting to login page...</p>
                    </div>
                `;
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }
            
            addDebugStep(`‚úÖ Valid authentication confirmed for: ${userData.kerberos}`, 'success');
            
            updateUserDisplay(userData);
            const userID = generateUserID(userData);
            
            // Store current user globally (but don't rely on localStorage)
            window.currentUser = userData;
            
            loadVoiceflow(userID, userData);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            addDebugStep('DOM Content Loaded', 'info');
            
            // Add session info to debug
            addDebugStep(`Session Start: ${new Date().toISOString()}`, 'info');
            addDebugStep(`Browser: ${navigator.userAgent.substring(0, 50)}...`, 'info');
            addDebugStep(`Current URL: ${window.location.href}`, 'info');
            
            initializePage();
        });

        // Clear data on page unload to prevent cross-contamination
        window.addEventListener('beforeunload', function() {
            // Only clear session data, not permanent OAuth tokens
            sessionStorage.clear();
        });
    </script>
</body>
</html>
