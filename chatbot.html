<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroAstro Chatbot</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .user-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        .user-info.visible {
            display: block;
        }
        .info-row {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 5px;
        }
        .info-label {
            font-weight: 600;
            color: #555;
        }
        .info-value {
            color: #333;
        }
        .chat-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 400px;
        }
        .debug-panel {
            background: #e8f4f8;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-size: 12px;
        }
        .debug-step {
            margin: 10px 0;
            padding: 8px;
            background: white;
            border-radius: 4px;
        }
        .success { border-left: 4px solid #27ae60; }
        .warning { border-left: 4px solid #f39c12; }
        .error { border-left: 4px solid #e74c3c; }
        .voiceflow-test {
            background: #fff3cd;
            border: 2px solid #f39c12;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>AeroAstro Chatbot</h1>
        <p>AI Assistant for MIT's Department of Aeronautics and Astronautics</p>
    </div>

    <div class="user-info" id="user-info">
        <div class="info-row">
            <span class="info-label">Welcome:</span>
            <span class="info-value" id="display-name">Loading...</span>
        </div>
        <div class="info-row">
            <span class="info-label">Kerberos:</span>
            <span class="info-value" id="display-kerberos">Loading...</span>
        </div>
        <div class="info-row">
            <span class="info-label">Title:</span>
            <span class="info-value" id="display-title">Loading...</span>
        </div>
        <div class="info-row">
            <span class="info-label">Department:</span>
            <span class="info-value" id="display-department">Loading...</span>
        </div>
    </div>

    <div class="voiceflow-test">
        <h4>üß™ Voiceflow Variable Test</h4>
        <p>If variables are working, you should see a debug message in the chat after opening.</p>
        <p><strong>Expected:</strong> "DEBUG: Variables set - Name: [Real Name], Title: [Real Title]"</p>
        <p><strong>Key Fix:</strong> user_authenticated is now always set to TRUE when OAuth data exists</p>
    </div>

    <div class="debug-panel">
        <h3>üîç Debug Information</h3>
        <div id="debug-steps"></div>
    </div>

    <div class="chat-container">
        <p><b>Welcome! Starting your personalized AeroAstro AI assistant...</b></p>
        <div id="voiceflow-chat"></div>
    </div>

    <script type="text/javascript">
        let debugSteps = [];
        
        function addDebugStep(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            debugSteps.push({timestamp, message, type});
            
            const debugDiv = document.getElementById('debug-steps');
            debugDiv.innerHTML = debugSteps.map(step => 
                `<div class="debug-step ${step.type}">
                    <strong>[${step.timestamp}]</strong> ${step.message}
                </div>`
            ).join('');
            
            console.log(`[DEBUG ${timestamp}] ${message}`);
        }

        // Function to get URL parameters
        function getURLParameter(name) {
            return new URLSearchParams(window.location.search).get(name);
        }

        // Function to get stored metadata
        function getStoredMetadata() {
            try {
                const stored = localStorage.getItem('user_metadata');
                return stored ? JSON.parse(stored) : null;
            } catch (e) {
                addDebugStep(`Error parsing localStorage: ${e.message}`, 'error');
                return null;
            }
        }

        // Collect all user data from URL params and localStorage
        function collectUserData() {
            addDebugStep('Starting user data collection...', 'info');
            
            // Get data from URL parameters first
            const urlData = {
                name: getURLParameter('name'),
                firstName: getURLParameter('firstName'),
                lastName: getURLParameter('lastName'),
                kerberos: getURLParameter('kerberos'),
                email: getURLParameter('email'),
                title: getURLParameter('title'),
                department: getURLParameter('department'),
                groups: getURLParameter('groups'),
                authenticated: getURLParameter('authenticated')
            };

            addDebugStep(`URL Parameters: ${JSON.stringify(urlData, null, 2)}`, 'info');

            // Get data from localStorage
            const storedData = getStoredMetadata();
            addDebugStep(`localStorage Data: ${JSON.stringify(storedData, null, 2)}`, 'info');

            // PKCE VERIFIER DEBUGGING AND CLEANUP
            const currentVerifier = localStorage.getItem('pkce_verifier');
            const currentState = localStorage.getItem('pkce_state');
            addDebugStep(`üîê PKCE Debug - Current verifier: ${currentVerifier ? currentVerifier.substring(0, 20) + '...' : 'MISSING'}`, 'warning');
            addDebugStep(`üîê PKCE Debug - Current state: ${currentState || 'MISSING'}`, 'warning');
            addDebugStep(`üîê PKCE Debug - Verifier length: ${currentVerifier ? currentVerifier.length : 0} chars`, 'warning');
            
            // PKCE CLEANUP: Remove stale PKCE tokens if we have fresh OAuth data from URL
            if (urlData.authenticated === 'true' && urlData.kerberos) {
                if (currentVerifier || currentState) {
                    addDebugStep('üßπ Fresh OAuth detected, clearing stale PKCE tokens...', 'info');
                    localStorage.removeItem('pkce_verifier');
                    localStorage.removeItem('pkce_state');
                    localStorage.removeItem('oauth_state');
                    addDebugStep('‚úÖ Stale PKCE tokens cleared', 'success');
                }
            } else if (currentVerifier || currentState) {
                // Check if PKCE tokens are old (more than 10 minutes)
                const pkceTimestamp = localStorage.getItem('pkce_timestamp');
                if (pkceTimestamp) {
                    const age = Date.now() - parseInt(pkceTimestamp);
                    addDebugStep(`üïê PKCE token age: ${Math.round(age / 1000)} seconds`, 'info');
                    if (age > 600000) { // 10 minutes
                        addDebugStep('üßπ PKCE tokens are old (>10min), clearing...', 'warning');
                        localStorage.removeItem('pkce_verifier');
                        localStorage.removeItem('pkce_state');
                        localStorage.removeItem('oauth_state');
                        localStorage.removeItem('pkce_timestamp');
                        addDebugStep('‚úÖ Old PKCE tokens cleared', 'success');
                    }
                } else {
                    // No timestamp means really old tokens, clear them
                    addDebugStep('üßπ PKCE tokens have no timestamp, clearing...', 'warning');
                    localStorage.removeItem('pkce_verifier');
                    localStorage.removeItem('pkce_state');
                    localStorage.removeItem('oauth_state');
                    addDebugStep('‚úÖ Timestampless PKCE tokens cleared', 'success');
                }
            }
            
            // Check if this matches the OAuth token's expected pattern
            if (storedData && storedData.raw) {
                addDebugStep(`üîê PKCE Debug - Token issued at: ${new Date(storedData.raw.iat * 1000).toLocaleString()}`, 'warning');
                addDebugStep(`üîê PKCE Debug - Token expires at: ${new Date(storedData.raw.exp * 1000).toLocaleString()}`, 'warning');
                addDebugStep(`üîê PKCE Debug - Token nonce: ${storedData.raw.nonce || 'MISSING'}`, 'warning');
            }

            // Merge data (URL params take precedence over localStorage)
            const userData = {
                name: urlData.name || (storedData && storedData.name) || 
                      (urlData.firstName && urlData.lastName ? `${urlData.firstName} ${urlData.lastName}` : '') ||
                      (storedData && storedData.firstName && storedData.lastName ? `${storedData.firstName} ${storedData.lastName}` : '') ||
                      'User',
                firstName: urlData.firstName || (storedData && storedData.firstName) || '',
                lastName: urlData.lastName || (storedData && storedData.lastName) || '',
                kerberos: urlData.kerberos || (storedData && storedData.kerberos) || '',
                email: urlData.email || (storedData && storedData.email) || '',
                title: urlData.title || (storedData && storedData.title) || '',
                department: urlData.department || (storedData && storedData.department) || '',
                groups: urlData.groups || (storedData && storedData.groups) || '',
                // FIXED: Force authenticated to true if we have OAuth data in localStorage OR URL
                authenticated: urlData.authenticated === 'true' || 
                              !!(storedData && storedData.kerberos), // Force true if we have kerberos
                loginTime: (storedData && storedData.loginTime) || new Date().toISOString()
            };

            addDebugStep(`Authentication logic: URL=${urlData.authenticated}, HasStoredKerberos=${!!(storedData && storedData.kerberos)}, FinalAuth=${userData.authenticated}`, 'info');

            // CROSS-CONTAMINATION CHECK
            if (userData.kerberos && currentVerifier) {
                addDebugStep(`üîç Cross-contamination check: User=${userData.kerberos}, VerifierExists=${!!currentVerifier}`, 'warning');
                // Simple heuristic: if kerberos doesn't match expected pattern with verifier timing
                const timeDiff = Date.now() - (storedData?.loginTime ? new Date(storedData.loginTime).getTime() : 0);
                addDebugStep(`üîç Time since OAuth: ${Math.round(timeDiff / 1000)} seconds`, 'warning');
                if (timeDiff > 300000) { // More than 5 minutes
                    addDebugStep(`‚ö†Ô∏è  OAuth data is old (>5min) but verifier still exists - possible contamination`, 'error');
                }
            }

            addDebugStep(`Final merged userData: ${JSON.stringify(userData, null, 2)}`, 'success');
            return userData;
        }

        // Update the display with user information
        function updateUserDisplay(userData) {
            addDebugStep('Updating user display...', 'info');
            
            if (userData.authenticated || userData.kerberos) {
                document.getElementById('display-name').textContent = userData.name || 'Not provided';
                document.getElementById('display-kerberos').textContent = userData.kerberos || 'Not provided';
                document.getElementById('display-title').textContent = userData.title || 'Not provided';
                document.getElementById('display-department').textContent = userData.department || 'Not provided';
                
                document.getElementById('user-info').classList.add('visible');
                addDebugStep('User info display updated successfully', 'success');
            } else {
                addDebugStep('No authenticated user data found', 'warning');
            }
        }

        // Generate userID for Voiceflow with URL fallback
        function generateUserID(userData) {
            addDebugStep('Generating userID for Voiceflow...', 'info');
            
            // Get kerberos from URL parameters directly as backup
            const urlKerberos = new URLSearchParams(window.location.search).get('kerberos');
            const kerberos = userData.kerberos || urlKerberos;
            
            if (kerberos) {
                const userID = `mit-${kerberos}`;
                addDebugStep(`Generated stable userID: ${userID}`, 'success');
                return userID;
            }
            
            let userID = localStorage.getItem('userID');
            if (!userID) {
                userID = 'user-' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('userID', userID);
            }
            addDebugStep(`Fallback userID: ${userID}`, 'warning');
            return userID;
        }

        // Load Voiceflow and set OAuth variables
        function loadVoiceflow(userID, userData) {
            addDebugStep('Starting Voiceflow load process...', 'info');
            
            (function(d, t) {
                var v = d.createElement(t), s = d.getElementsByTagName(t)[0];
                v.onload = function() {
                    addDebugStep('Voiceflow script loaded', 'success');
                    
                    // Load Voiceflow with the working project ID
                    window.voiceflow.chat.load({
                        verify: { projectID: '66de313d6a0d94e1bd71c5ce' }, // Use the working project ID
                        url: 'https://general-runtime.voiceflow.com',
                        versionID: 'production',
                        userID: userID,
                        assistant: {
                            persistence: 'memory'
                        },
                        voice: {
                            url: "https://runtime-api.voiceflow.com"
                        }
                    });
                    
                    addDebugStep('Voiceflow chat.load() called with production version', 'success');
                    
                    // Set Voiceflow variables with real OAuth data
                    setTimeout(() => {
                        addDebugStep('Attempting to set Voiceflow variables...', 'info');
                        
                        if (window.voiceflow && window.voiceflow.chat) {
                            addDebugStep('window.voiceflow.chat is available', 'success');
                            
                            const variablePayload = {
                                user_name: userData.name || '',
                                user_kerberos: userData.kerberos || '',
                                user_title: userData.title || '',
                                user_department: userData.department || '',
                                user_email: userData.email || '',
                                user_firstname: userData.firstName || '',
                                user_lastname: userData.lastName || '',
                                user_authenticated: true // Always set to true if we have OAuth data
                            };
                            
                            addDebugStep(`Setting variables: ${JSON.stringify(variablePayload, null, 2)}`, 'info');
                            
                            try {
                                // Set variables using the correct method
                                window.voiceflow.chat.interact({
                                    type: 'set',
                                    payload: variablePayload
                                });
                                addDebugStep('‚úÖ Variables set successfully!', 'success');
                                
                                // Send debug verification message
                                setTimeout(() => {
                                    addDebugStep('Sending debug verification to Voiceflow...', 'info');
                                    try {
                                        const debugMessage = `DEBUG: Variables set - Name: ${variablePayload.user_name}, Title: ${variablePayload.user_title}, Dept: ${variablePayload.user_department} | UserID: ${userID} | Kerberos: ${userData.kerberos}`;
                                        
                                        window.voiceflow.chat.interact({
                                            type: 'text',
                                            payload: {
                                                query: debugMessage
                                            }
                                        });
                                        
                                        addDebugStep('‚úÖ Debug message sent to Voiceflow', 'success');
                                        
                                    } catch (debugError) {
                                        addDebugStep(`‚ùå Error sending debug message: ${debugError.message}`, 'error');
                                    }
                                }, 2000);
                                
                                // Open chat after variables are set
                                setTimeout(() => {
                                    addDebugStep('Opening Voiceflow chat...', 'info');
                                    try {
                                        window.voiceflow.chat.open();
                                        addDebugStep('‚úÖ Chat opened successfully!', 'success');
                                    } catch (openError) {
                                        addDebugStep(`‚ùå Error opening chat: ${openError.message}`, 'error');
                                    }
                                }, 3000);
                                
                            } catch (setError) {
                                addDebugStep(`‚ùå Error setting variables: ${setError.message}`, 'error');
                            }
                        } else {
                            addDebugStep('‚ùå window.voiceflow.chat not available', 'error');
                        }
                    }, 2000);
                };
                
                v.onerror = function() {
                    addDebugStep('‚ùå Error loading Voiceflow script', 'error');
                };
                
                v.src = "https://cdn.voiceflow.com/widget-next/bundle.mjs"; 
                v.type = "text/javascript"; 
                s.parentNode.insertBefore(v, s);
                
                addDebugStep('Voiceflow script tag added to page', 'info');
            })(document, 'script');
        }

        // Initialize the page
        function initializePage() {
            addDebugStep('Page initialization started', 'info');
            
            const allLocalStorageKeys = Object.keys(localStorage);
            addDebugStep(`All localStorage keys: ${allLocalStorageKeys.join(', ')}`, 'warning');
            
            if (localStorage.getItem('user_metadata')) {
                const existing = JSON.parse(localStorage.getItem('user_metadata'));
                addDebugStep(`Found existing user data for: ${existing.kerberos || 'unknown'}`, 'warning');
            }
            
            const userData = collectUserData();
            
            // Check if user has valid OAuth data
            if (!userData.authenticated && !userData.kerberos) {
                addDebugStep('No OAuth data found, redirecting to login...', 'warning');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 3000);
                return;
            }
            
            addDebugStep('Valid OAuth data found, proceeding with chat initialization', 'success');
            
            updateUserDisplay(userData);
            const userID = generateUserID(userData);
            
            window.currentUser = userData;
            addDebugStep('Global currentUser variable set', 'info');
            
            loadVoiceflow(userID, userData);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            addDebugStep('DOM Content Loaded', 'info');
            initializePage();
        });
        
        // Add browser info
        addDebugStep(`Browser: ${navigator.userAgent}`, 'info');
        addDebugStep(`Current URL: ${window.location.href}`, 'info');
    </script>
</body>
</html>
