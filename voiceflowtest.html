<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voiceflow Variable Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-controls {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        input, button {
            margin: 5px;
            padding: 8px;
        }
        #console-output {
            background: #000;
            color: #0f0;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            border-radius: 4px;
            height: 200px;
            overflow-y: scroll;
        }
    </style>
</head>
<body>
    <h1>Voiceflow Variable Test</h1>
    
    <div class="test-controls">
        <h3>Test Variables (Using Known Voiceflow Variables)</h3>
        <input type="text" id="user_name" placeholder="user_name" value="Test User">
        <input type="text" id="user_kerberos" placeholder="user_kerberos" value="testuser">
        <input type="text" id="user_email" placeholder="user_email" value="test@mit.edu">
        <input type="text" id="user_title" placeholder="user_title" value="Test Title">
        <input type="text" id="user_department" placeholder="user_department" value="Test Department">
        <br>
        <button onclick="loadVoiceflowWithTestData()">Load Voiceflow with Test Data</button>
        <button onclick="clearConsole()">Clear Console</button>
    </div>

    <div id="console-output"></div>

    <div id="voiceflow-chat"></div>

    <script>
        function log(message) {
            const output = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }

        function clearConsole() {
            document.getElementById('console-output').innerHTML = '';
        }

        function loadVoiceflowWithTestData() {
            // Get values using the exact variable names from Voiceflow
            const userName = document.getElementById('user_name').value;
            const userKerberos = document.getElementById('user_kerberos').value;
            const userEmail = document.getElementById('user_email').value;
            const userTitle = document.getElementById('user_title').value;
            const userDepartment = document.getElementById('user_department').value;
            
            log('Starting Voiceflow load with existing variable names...');
            log(`user_name: ${userName}`);
            log(`user_kerberos: ${userKerberos}`);
            log(`user_email: ${userEmail}`);
            log(`user_title: ${userTitle}`);
            log(`user_department: ${userDepartment}`);

            // Clear any existing Voiceflow
            if (window.voiceflow && window.voiceflow.chat) {
                try {
                    window.voiceflow.chat.destroy();
                    log('Destroyed existing Voiceflow instance');
                } catch (e) {
                    log('No existing instance to destroy');
                }
            }

            // Load Voiceflow script
            const script = document.createElement('script');
            script.src = "https://cdn.voiceflow.com/widget-next/bundle.mjs";
            script.type = "text/javascript";
            
            script.onload = function() {
                log('Voiceflow script loaded');
                
                // Generate unique userID for this test
                const testUserID = 'test-' + Date.now();
                log(`Using userID: ${testUserID}`);

                try {
                    // Load with variables in launch payload using exact Voiceflow variable names
                    const config = {
                        verify: { projectID: '66de313d6a0d94e1bd71c5ce' },
                        url: 'https://general-runtime.voiceflow.com',
                        versionID: 'production',
                        userID: testUserID,
                        launch: { 
                            event: { 
                                type: 'launch', 
                                payload: { 
                                    user_name: userName,
                                    user_kerberos: userKerberos,
                                    user_email: userEmail,
                                    user_title: userTitle,
                                    user_department: userDepartment,
                                    user_authenticated: true
                                } 
                            } 
                        },
                        assistant: {
                            persistence: 'memory'
                        },
                        voice: {
                            url: "https://runtime-api.voiceflow.com"
                        }
                    };
                    
                    log('Config created with exact variable names, loading Voiceflow...');
                    log('Payload: ' + JSON.stringify(config.launch.event.payload, null, 2));
                    
                    window.voiceflow.chat.load(config);
                    log('Voiceflow loaded with launch payload');

                    // Open chat after short delay
                    setTimeout(() => {
                        try {
                            window.voiceflow.chat.open();
                            log('Chat opened - check if variables appear correctly');
                            log('Expected: Should show "Test User" instead of "John Smith"');
                        } catch (e) {
                            log('Error opening chat: ' + e.message);
                        }
                    }, 2000);

                } catch (e) {
                    log('Error loading Voiceflow: ' + e.message);
                }
            };

            script.onerror = function() {
                log('Error loading Voiceflow script');
            };

            document.head.appendChild(script);
        }

        log('Test page ready. Enter test values and click "Load Voiceflow"');
    </script>
</body>
</html>
