<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Processing login</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
    .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
    .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
    .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
    .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
    .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
    pre { background: #f8f9fa; padding: 10px; border-radius: 3px; font-size: 12px; overflow-x: auto; max-height: 300px; }
    .debug-section { margin: 20px 0; }
  </style>
</head>
<body>
  <h2>Processing Login...</h2>
  <div id="status"></div>
  
  <div class="debug-section">
    <h3>Debug Information</h3>
    <div id="debug-info"></div>
  </div>

  <script>
    function addStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      const timestamp = new Date().toLocaleTimeString();
      statusDiv.innerHTML += `<div class="status ${type}">[${timestamp}] ${message}</div>`;
      console.log(`[${timestamp}] ${message}`);
    }

    function updateDebugInfo(info) {
      document.getElementById('debug-info').innerHTML = `<pre>${JSON.stringify(info, null, 2)}</pre>`;
    }

    (async () => {
      try {
        addStatus('Starting callback processing...', 'info');

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');
        const errorDescription = urlParams.get('error_description');

        addStatus('Retrieved URL parameters', 'info');

        // Check for OAuth errors first
        if (error) {
          addStatus(`OAuth Error: ${error}`, 'error');
          if (errorDescription) {
            addStatus(`Error Description: ${errorDescription}`, 'error');
          }
          return;
        }

        // Get stored values from localStorage
        const verifier = localStorage.getItem('pkce_verifier');
        const savedState = localStorage.getItem('pkce_state');

        // Debug info
        const debugInfo = {
          url_params: {
            code: code ? `${code.substring(0, 10)}...` : null,
            state: state,
            error: error,
            error_description: errorDescription
          },
          localStorage_data: {
            verifier: verifier ? `${verifier.substring(0, 10)}...` : null,
            saved_state: savedState,
            verifier_length: verifier ? verifier.length : 0,
            state_matches: state === savedState
          },
          validation: {
            has_code: !!code,
            has_state: !!state,
            has_verifier: !!verifier,
            states_match: state === savedState
          }
        };

        updateDebugInfo(debugInfo);

        // Validation
        if (!code) {
          addStatus('ERROR: No authorization code received', 'error');
          return;
        }

        if (!state) {
          addStatus('ERROR: No state parameter received', 'error');
          return;
        }

        if (!verifier) {
          addStatus('ERROR: No PKCE verifier found in localStorage', 'error');
          return;
        }

        if (state !== savedState) {
          addStatus(`ERROR: State mismatch! Received: ${state}, Expected: ${savedState}`, 'error');
          return;
        }

        addStatus('All parameters validated successfully', 'success');

        // Prepare request to Netlify function
        const requestPayload = { code, verifier };
        addStatus('Sending request to Netlify function...', 'info');

        const res = await fetch('/.netlify/functions/oidc-callback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestPayload)
        });

        addStatus(`Received response: ${res.status} ${res.statusText}`, res.ok ? 'success' : 'error');

        if (!res.ok) {
          const responseText = await res.text();
          addStatus(`Response body: ${responseText}`, 'error');
          
          // Try to parse as JSON for better error display
          let errorData;
          try {
            errorData = JSON.parse(responseText);
            updateDebugInfo({
              ...debugInfo,
              error_response: errorData
            });
          } catch (e) {
            updateDebugInfo({
              ...debugInfo,
              error_response: { raw_text: responseText }
            });
          }

          throw new Error(`Token exchange failed: ${responseText}`);
        }

        const json = await res.json();
        addStatus('Successfully received user data', 'success');

        // Update debug info with response
        updateDebugInfo({
          ...debugInfo,
          success_response: {
            name: json.name,
            email: json.email,
            kerberos: json.kerberos,
            // Don't show raw token data for security
            has_raw_data: !!json.raw
          }
        });

        addStatus('Redirecting to chatbot...', 'info');

        // Redirect to chatbot with the user info returned by the function
        const chatbotUrl = `/chatbot.html?name=${encodeURIComponent(json.name || '')}&email=${encodeURIComponent(json.email || '')}&kerberos=${encodeURIComponent(json.kerberos || '')}`;
        
        setTimeout(() => {
          window.location.href = chatbotUrl;
        }, 2000); // 2 second delay to see the success message

      } catch (err) {
        addStatus(`FATAL ERROR: ${err.message}`, 'error');
        console.error('Callback error:', err);
        
        updateDebugInfo({
          fatal_error: {
            message: err.message,
            stack: err.stack
          }
        });
      }
    })();
  </script>
</body>
</html>
