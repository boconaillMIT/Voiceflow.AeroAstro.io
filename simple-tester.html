<!DOCTYPE html>
<html>
<head>
    <title>Voiceflow Chatbot Tester v2</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0;
            padding: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            gap: 20px;
            height: 90vh;
        }
        .panel { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .chatbot-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 8px 0;
            width: 100%;
            font-size: 14px;
            font-weight: bold;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.green { background: #28a745; }
        button.gray { background: #6c757d; }
        button.red { background: #dc3545; }
        .status { 
            padding: 12px; 
            border-radius: 4px; 
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .section {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            background: #f8f9fa;
        }
        .section h4 {
            margin: 0 0 15px 0;
            color: #495057;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin: 8px 0;
            box-sizing: border-box;
            font-family: inherit;
        }
        textarea {
            resize: vertical;
            font-family: monospace;
            font-size: 13px;
        }
        label {
            display: block;
            margin: 8px 0 4px 0;
            font-weight: bold;
            font-size: 13px;
        }
        .questions-display {
            background: #e9ecef;
            border: 1px solid #adb5bd;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }
        .question-item {
            padding: 6px;
            margin: 3px 0;
            border-radius: 3px;
            background: white;
        }
        .transcript {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-size: 13px;
            margin: 15px 0;
        }
        .message {
            margin: 8px 0;
            padding: 8px;
            border-radius: 6px;
        }
        .message.user {
            background: #007bff;
            color: white;
            margin-left: 20%;
        }
        .message.bot {
            background: #e9ecef;
            color: #333;
            margin-right: 20%;
        }
        .message.system {
            background: #fff3cd;
            color: #856404;
            text-align: center;
            font-style: italic;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .debug {
            font-family: monospace;
            font-size: 11px;
            color: #6c757d;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel: Controls -->
        <div class="panel">
            <h2>ü§ñ Chatbot Tester v2</h2>
            
            <div class="section">
                <h4>üìù Load Questions</h4>
                
                <button onclick="useDefaultQuestions()" class="gray">üîÑ Use Built-in Questions (10 questions)</button>
                
                <label>Manual Questions (edit as needed):</label>
                <textarea id="questionTextArea" rows="6">What are the admission requirements?
How do I apply for financial aid?
What research opportunities are available?
Who should I contact about course registration?
What courses are required for the degree?</textarea>
                <button onclick="loadFromTextArea()" class="green">üìù Load These Questions</button>
                
                <label>Google Sheet ID (optional):</label>
                <input type="text" id="googleSheetId" placeholder="Enter Google Sheet ID" value="1flnWLAXZGoTpDjkRMuuD3LvyphYIij0gruCu_4x__gQ">
                <button onclick="tryGoogleSheets()" id="googleBtn">üì• Try Google Sheets</button>
                <div class="debug" id="googleStatus">Ready to try Google Sheets</div>
            </div>

            <div class="section">
                <h4>‚öôÔ∏è Settings</h4>
                <label>Delay between questions (seconds):</label>
                <input type="number" id="delaySeconds" value="6" min="3" max="30">
            </div>

            <div class="status" id="mainStatus">Ready - load questions above</div>

            <button onclick="loadChatbot()" id="loadChatBtn">üîó Load Chatbot</button>
            <button onclick="startTest()" id="startBtn" disabled>‚ñ∂Ô∏è Start Automated Test</button>
            <button onclick="stopTest()" id="stopBtn" disabled class="red">‚èπÔ∏è Stop Test</button>

            <div class="questions-display" id="questionsDisplay">
                <div style="text-align: center; color: #6c757d;">Load questions above to see them here</div>
            </div>
        </div>

        <!-- Middle Panel: Chatbot -->
        <div class="chatbot-panel">
            <iframe id="chatIframe" src="about:blank"></iframe>
        </div>

        <!-- Right Panel: Transcript -->
        <div class="panel">
            <h3>üí¨ Live Transcript</h3>
            <div class="transcript" id="transcript">
                <div class="message system">Transcript will appear here during testing</div>
            </div>
            <button onclick="clearTranscript()">üóëÔ∏è Clear Transcript</button>
            <button onclick="copyToClipboard()">üìã Copy Transcript</button>
        </div>
    </div>

    <script>
        // Global variables
        let questionsList = [];
        let currentQuestionIndex = 0;
        let testInterval = null;
        let chatbotReady = false;

        // Helper functions
        function addMessage(text, type = 'system') {
            const transcript = document.getElementById('transcript');
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.innerHTML = `${text}<br><small>${new Date().toLocaleTimeString()}</small>`;
            transcript.appendChild(msg);
            transcript.scrollTop = transcript.scrollHeight;
        }

        function updateStatus(text, type = 'info') {
            const status = document.getElementById('mainStatus');
            status.textContent = text;
            status.className = `status ${type}`;
        }

        function displayQuestions() {
            const display = document.getElementById('questionsDisplay');
            if (questionsList.length === 0) {
                display.innerHTML = '<div style="text-align: center; color: #6c757d;">No questions loaded</div>';
                return;
            }
            
            display.innerHTML = questionsList.map((q, i) => 
                `<div class="question-item">${i + 1}. ${q}</div>`
            ).join('');
        }

        // Question loading functions
        function useDefaultQuestions() {
            questionsList = [
                "What are the admission requirements?",
                "How do I apply for financial aid?",
                "What research opportunities are available?",
                "Who should I contact about course registration?",
                "What courses are required for the aerospace engineering degree?",
                "What is the application deadline?",
                "How do I schedule a campus visit?",
                "What scholarships are available?",
                "Tell me about the faculty research areas",
                "What are the prerequisites for graduate programs?"
            ];
            
            updateStatus(`Loaded ${questionsList.length} default questions`, 'success');
            addMessage(`‚úÖ Loaded ${questionsList.length} built-in questions`);
            displayQuestions();
            checkReadyToTest();
        }

        function loadFromTextArea() {
            const textarea = document.getElementById('questionTextArea');
            const text = textarea.value.trim();
            
            if (!text) {
                updateStatus('Please enter some questions in the text area', 'error');
                addMessage('‚ùå Text area is empty');
                return;
            }

            const questions = text.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);

            if (questions.length === 0) {
                updateStatus('No valid questions found', 'error');
                addMessage('‚ùå No valid questions found in text area');
                return;
            }

            questionsList = questions;
            updateStatus(`Loaded ${questionsList.length} questions from text area`, 'success');
            addMessage(`‚úÖ Loaded ${questionsList.length} questions from text area`);
            displayQuestions();
            checkReadyToTest();
        }

        async function tryGoogleSheets() {
            const sheetId = document.getElementById('googleSheetId').value.trim();
            if (!sheetId) {
                updateStatus('Please enter a Google Sheet ID', 'error');
                return;
            }

            const btn = document.getElementById('googleBtn');
            const status = document.getElementById('googleStatus');
            
            btn.textContent = '‚è≥ Loading...';
            btn.disabled = true;
            status.textContent = `Trying to load from: ${sheetId}`;
            
            updateStatus('Attempting to load from Google Sheets...', 'warning');
            addMessage(`üîÑ Attempting to load from Google Sheet: ${sheetId}`);

            try {
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0`;
                addMessage(`üì° Fetching: ${url}`);
                
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 8000); // 8 second timeout
                
                const response = await fetch(url, {
                    signal: controller.signal,
                    mode: 'cors'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} - Sheet may not be published or accessible`);
                }

                const csvText = await response.text();
                if (!csvText.trim()) {
                    throw new Error('Empty response from Google Sheets');
                }

                const lines = csvText.split('\n');
                const questions = lines
                    .slice(1) // Skip header
                    .map(line => line.split(',')[0]) // First column
                    .filter(q => q && q.trim())
                    .map(q => q.replace(/"/g, '').trim());

                if (questions.length === 0) {
                    throw new Error('No questions found in first column');
                }

                questionsList = questions;
                updateStatus(`Loaded ${questionsList.length} questions from Google Sheets`, 'success');
                addMessage(`‚úÖ Successfully loaded ${questionsList.length} questions from Google Sheets`);
                status.textContent = `Success: ${questionsList.length} questions loaded`;
                displayQuestions();
                checkReadyToTest();

            } catch (error) {
                let errorMsg = error.message;
                if (error.name === 'AbortError') {
                    errorMsg = 'Timed out after 8 seconds';
                }
                
                updateStatus(`Google Sheets failed: ${errorMsg}`, 'error');
                addMessage(`‚ùå Google Sheets error: ${errorMsg}`);
                addMessage(`üí° Try copying questions manually instead`);
                status.textContent = `Failed: ${errorMsg}`;
            } finally {
                btn.textContent = 'üì• Try Google Sheets';
                btn.disabled = false;
            }
        }

        // Chatbot functions
        function loadChatbot() {
            const iframe = document.getElementById('chatIframe');
            iframe.src = 'https://aeroastrovfbot.netlify.app/chatbot.html';
            
            updateStatus('Loading chatbot...', 'warning');
            addMessage('üîó Loading chatbot...');
            
            iframe.onload = function() {
                addMessage('‚úÖ Chatbot page loaded, waiting for Voiceflow...');
                updateStatus('Chatbot loaded, waiting for Voiceflow...', 'info');
                
                setTimeout(() => {
                    chatbotReady = true;
                    updateStatus('Chatbot ready!', 'success');
                    addMessage('‚úÖ Voiceflow should be ready now');
                    checkReadyToTest();
                }, 8000);
            };
        }

        function checkReadyToTest() {
            const startBtn = document.getElementById('startBtn');
            if (questionsList.length > 0 && chatbotReady) {
                startBtn.disabled = false;
                updateStatus('Ready to start testing!', 'success');
            }
        }

        // Testing functions
        function startTest() {
            if (questionsList.length === 0) {
                updateStatus('Please load questions first', 'error');
                return;
            }
            if (!chatbotReady) {
                updateStatus('Please load chatbot first', 'error');
                return;
            }

            const delay = parseInt(document.getElementById('delaySeconds').value) * 1000;
            currentQuestionIndex = 0;
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            updateStatus('Testing in progress...', 'warning');
            addMessage(`üöÄ Starting test with ${questionsList.length} questions`);
            
            sendNextQuestion();
            testInterval = setInterval(sendNextQuestion, delay);
        }

        function sendNextQuestion() {
            if (currentQuestionIndex >= questionsList.length) {
                stopTest();
                updateStatus('All questions completed!', 'success');
                addMessage('üéâ All questions completed!');
                return;
            }

            const question = questionsList[currentQuestionIndex];
            const questionNum = currentQuestionIndex + 1;
            
            addMessage(question, 'user');
            
            try {
                const iframe = document.getElementById('chatIframe');
                const voiceflow = iframe.contentWindow.voiceflow;
                
                if (voiceflow && voiceflow.chat && voiceflow.chat.interact) {
                    voiceflow.chat.interact({
                        type: 'text',
                        payload: question
                    });
                    
                    console.log(`Sent Q${questionNum}: ${question}`);
                    
                    // Try to capture actual bot response
                    setTimeout(() => {
                        let botResponse = 'Response received (content not accessible via iframe)';
                        
                        try {
                            // Try to access Voiceflow's shadow DOM for actual response
                            const voiceflow = iframe.contentWindow.voiceflow;
                            if (voiceflow && voiceflow.chat && voiceflow.chat._shadowRoot) {
                                const shadowRoot = voiceflow.chat._shadowRoot;
                                
                                // Look for the latest bot response using the correct selector
                                const botResponses = shadowRoot.querySelectorAll('.vfrc-system-response');
                                if (botResponses.length > 0) {
                                    const latestResponse = botResponses[botResponses.length - 1];
                                    const text = latestResponse.textContent || latestResponse.innerText;
                                    if (text && text.trim()) {
                                        botResponse = text.trim();
                                    }
                                }
                            }
                        } catch (error) {
                            console.log('Response capture error:', error);
                        }
                        
                        addMessage(botResponse, 'bot');
                    }, 2000);
                    
                } else {
                    addMessage('Error: Cannot access Voiceflow in iframe', 'system');
                }
            } catch (error) {
                addMessage(`Error sending question: ${error.message}`, 'system');
            }

            currentQuestionIndex++;
        }

        function stopTest() {
            if (testInterval) {
                clearInterval(testInterval);
                testInterval = null;
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            updateStatus('Test stopped', 'info');
            addMessage('‚èπÔ∏è Test stopped');
        }

        // Utility functions
        function clearTranscript() {
            document.getElementById('transcript').innerHTML = 
                '<div class="message system">Transcript cleared</div>';
        }

        function copyToClipboard() {
            const transcript = document.getElementById('transcript');
            const text = Array.from(transcript.children)
                .map(div => div.textContent)
                .join('\n');
            
            navigator.clipboard.writeText(text).then(() => {
                addMessage('üìã Transcript copied to clipboard');
            });
        }

        // Initialize
        window.addEventListener('load', () => {
            addMessage('ü§ñ Chatbot Tester v2 Ready');
            addMessage('Step 1: Load questions using options above');
            addMessage('Step 2: Load chatbot');
            addMessage('Step 3: Start testing');
        });
    </script>
</body>
</html>
