<!DOCTYPE html>
<html>
<head>
    <title>Voiceflow Chatbot Tester v3</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0;
            padding: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            gap: 20px;
            height: 90vh;
        }
        .panel { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .chatbot-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 8px 0;
            width: 100%;
            font-size: 14px;
            font-weight: bold;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.green { background: #28a745; }
        button.gray { background: #6c757d; }
        button.red { background: #dc3545; }
        .status { 
            padding: 12px; 
            border-radius: 4px; 
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .section {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            background: #f8f9fa;
        }
        .section h4 {
            margin: 0 0 15px 0;
            color: #495057;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin: 8px 0;
            box-sizing: border-box;
            font-family: inherit;
        }
        textarea {
            resize: vertical;
            font-family: monospace;
            font-size: 13px;
        }
        label {
            display: block;
            margin: 8px 0 4px 0;
            font-weight: bold;
            font-size: 13px;
        }
        .questions-display {
            background: #e9ecef;
            border: 1px solid #adb5bd;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }
        .question-item {
            padding: 6px;
            margin: 3px 0;
            border-radius: 3px;
            background: white;
        }
        .transcript {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            height: 500px;
            overflow-y: auto;
            font-size: 13px;
            margin: 15px 0;
        }
        .message {
            margin: 8px 0;
            padding: 8px;
            border-radius: 6px;
        }
        .message.user {
            background: #007bff;
            color: white;
            margin-left: 20%;
        }
        .message.bot {
            background: #e9ecef;
            color: #333;
            margin-right: 20%;
        }
        .message.system {
            background: #fff3cd;
            color: #856404;
            text-align: center;
            font-style: italic;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .debug {
            font-family: monospace;
            font-size: 11px;
            color: #6c757d;
            margin: 5px 0;
        }
        .question-item.current {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            font-weight: bold;
        }
        .question-item.completed {
            background: #d4edda;
            border-left: 3px solid #28a745;
        }
        .qa-pair {
            margin: 15px 0;
            padding: 12px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .qa-question {
            background: #007bff;
            color: white;
            padding: 10px;
            border-radius: 6px 6px 0 0;
            font-weight: bold;
        }
        .qa-answer {
            background: #e9ecef;
            color: #333;
            padding: 12px;
            border-radius: 0 0 6px 6px;
            margin-top: 2px;
            line-height: 1.6;
        }
        .qa-waiting {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 0 0 6px 6px;
            margin-top: 2px;
            font-style: italic;
        }
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        .stat-box {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 11px;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel: Controls -->
        <div class="panel">
            <h2>ü§ñ Chatbot Tester v3</h2>
                        <div class="debug" style="background: #e7f3ff; padding: 8px; border-radius: 4px; margin-bottom: 10px;">
                ‚ú® NEW: Direct API capture for perfect sync
            </div>
            <div class="section">
                <h4>üìù Load Questions</h4>
                
                <button onclick="useDefaultQuestions()" class="gray">üîÑ Use Built-in Questions (10 questions)</button>
                
                <label>Manual Questions (edit as needed):</label>
                <textarea id="questionTextArea" rows="6">who is the department head
                    who is the DAF
                    how can i create a budget?
                    how do i request a waiver
                    how do i request a proposal waiver
                    how do i request a waiver of search?
                    does the department still do waivers of search
                    where is Gabby Hoyte's office
                    who does Gabby Hoyte support?
                    who is the development officer?
                    who supports sertac karaman?</textarea>
                <button onclick="loadFromTextArea()" class="green">üìù Load These Questions</button>
                
                <label>Google Sheet ID (optional):</label>
                <input type="text" id="googleSheetId" placeholder="Enter Google Sheet ID" value="1flnWLAXZGoTpDjkRMuuD3LvyphYIij0gruCu_4x__gQ">
                <button onclick="tryGoogleSheets()" id="googleBtn">üì• Try Google Sheets</button>
                <div class="debug" id="googleStatus">Ready to try Google Sheets</div>
            </div>

            <div class="section">
                <h4>‚öôÔ∏è Settings</h4>
                <label>Max wait time per question (seconds):</label>
                <input type="number" id="maxWaitSeconds" value="15" min="5" max="60">
                <div class="debug">Test will wait up to this long for each response</div>
            </div>
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-number" id="statQuestions">0</div>
                    <div class="stat-label">Questions Loaded</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="statCompleted">0</div>
                    <div class="stat-label">Completed</div>
                </div>
            </div>
            <div class="status" id="mainStatus">Ready - load questions above</div>

            <button onclick="loadChatbot()" id="loadChatBtn">üîó Load Chatbot</button>
            <button onclick="startTest()" id="startBtn" disabled>‚ñ∂Ô∏è Start Automated Test</button>
            <button onclick="stopTest()" id="stopBtn" disabled class="red">‚èπÔ∏è Stop Test</button>

            <div class="questions-display" id="questionsDisplay">
                <div style="text-align: center; color: #6c757d;">Load questions above to see them here</div>
            </div>
        </div>

        <!-- Middle Panel: Chatbot -->
        <div class="chatbot-panel">
            <iframe id="chatIframe" src="about:blank"></iframe>
        </div>

        <!-- Right Panel: Transcript -->
        <div class="panel">
            <h3>üí¨ Live Q&A Transcript</h3>
            <div class="transcript" id="transcript">
                <div class="message system">Transcript will appear here during testing</div>
            </div>
            <button onclick="clearTranscript()">üóëÔ∏è Clear Transcript</button>
            <button onclick="copyToClipboard()" class="green">üìã Copy Transcript</button>
            <button onclick="exportToCSV()" class="gray">üìä Export CSV</button>
        </div>
    </div>

    <script>
        let questionsList = [];
        let currentQuestionIndex = 0;
        let chatbotReady = false;
        let testRunning = false;
        let qaResults = [];
        let waitingForResponse = false;
        let currentQuestionStartTime = null;
        let responseTimeout = null;
 // ============================================
        // MESSAGE LISTENER FOR API RESPONSES
        // ============================================
        window.addEventListener('message', function(event) {
            // Security check - only accept messages from our iframe
            const iframe = document.getElementById('chatIframe');
            if (event.source !== iframe.contentWindow) {
                return;
            }

            console.log('üì® Message received:', event.data);

            if (event.data.type === 'CHATBOT_READY') {
                chatbotReady = true;
                updateStatus('Chatbot ready - API interceptor active!', 'success');
                addSystemMessage('‚úÖ Chatbot loaded with API interceptor');
                checkReadyToTest();
            }

            if (event.data.type === 'VOICEFLOW_API_RESPONSE') {
                console.log('üì¶ Received API response:', event.data.data);
                
                if (waitingForResponse && testRunning) {
                    handleVoiceflowResponse(event.data.data);
                }
            }
        });

        // ============================================
        // HANDLE VOICEFLOW API RESPONSE
        // ============================================
        function handleVoiceflowResponse(apiData) {
            // Clear the timeout since we got a response
            if (responseTimeout) {
                clearTimeout(responseTimeout);
                responseTimeout = null;
            }

            // Extract text from Voiceflow API response
            let responseText = '';
            
            try {
                // Voiceflow returns an array of trace objects
                if (Array.isArray(apiData)) {
                    for (const trace of apiData) {
                        if (trace.type === 'text' && trace.payload && trace.payload.message) {
                            responseText += trace.payload.message + '\n\n';
                        } else if (trace.type === 'speak' && trace.payload && trace.payload.message) {
                            responseText += trace.payload.message + '\n\n';
                        }
                    }
                }
                
                responseText = responseText.trim();
                
                if (!responseText) {
                    responseText = 'Response received (no text content)';
                }
            } catch (e) {
                console.error('Error parsing API response:', e);
                responseText = 'Error parsing response';
            }

            const responseTime = Date.now() - currentQuestionStartTime;
            
            // Update the current Q&A pair
            const currentQuestion = questionsList[currentQuestionIndex - 1];
            qaResults[qaResults.length - 1] = {
                question: currentQuestion,
                answer: responseText,
                timestamp: new Date().toISOString(),
                responseTime: responseTime
            };

            // Update the transcript display
            updateTranscriptDisplay();
            updateStats();

            waitingForResponse = false;

            // Send next question after a short delay
            setTimeout(() => {
                if (testRunning) {
                    sendNextQuestion();
                }
            }, 1000);
        }

        // ============================================
        // UPDATE TRANSCRIPT DISPLAY
        // ============================================
        function updateTranscriptDisplay() {
            const transcript = document.getElementById('transcript');
            transcript.innerHTML = '';

            qaResults.forEach((qa, index) => {
                const qaDiv = document.createElement('div');
                qaDiv.className = 'qa-pair';
                
                const questionDiv = document.createElement('div');
                questionDiv.className = 'qa-question';
                questionDiv.textContent = `Q${index + 1}: ${qa.question}`;
                
                const answerDiv = document.createElement('div');
                if (qa.answer === 'WAITING') {
                    answerDiv.className = 'qa-waiting';
                    answerDiv.textContent = '‚è≥ Waiting for response...';
                } else {
                    answerDiv.className = 'qa-answer';
                    answerDiv.textContent = qa.answer;
                    
                    if (qa.responseTime) {
                        const timeInfo = document.createElement('div');
                        timeInfo.style.fontSize = '11px';
                        timeInfo.style.color = '#6c757d';
                        timeInfo.style.marginTop = '8px';
                        timeInfo.textContent = `‚è±Ô∏è Response time: ${(qa.responseTime / 1000).toFixed(1)}s`;
                        answerDiv.appendChild(timeInfo);
                    }
                }
                
                qaDiv.appendChild(questionDiv);
                qaDiv.appendChild(answerDiv);
                transcript.appendChild(qaDiv);
            });

            // Auto-scroll to bottom
            transcript.scrollTop = transcript.scrollHeight;
        }

        // ============================================
        // ADD SYSTEM MESSAGE
        // ============================================
        function addSystemMessage(message) {
            const transcript = document.getElementById('transcript');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.textContent = message;
            transcript.appendChild(messageDiv);
            transcript.scrollTop = transcript.scrollHeight;
        }

        // ============================================
        // UPDATE STATS
        // ============================================
        function updateStats() {
            document.getElementById('statQuestions').textContent = questionsList.length;
            document.getElementById('statCompleted').textContent = qaResults.filter(qa => qa.answer !== 'WAITING').length;
        }

        // Helper functions
        function addMessage(text, type = 'system') {
            const transcript = document.getElementById('transcript');
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.innerHTML = `${text}<br><small>${new Date().toLocaleTimeString()}</small>`;
            transcript.appendChild(msg);
            transcript.scrollTop = transcript.scrollHeight;
        }

        function updateStatus(text, type = 'info') {
            const status = document.getElementById('mainStatus');
            status.textContent = text;
            status.className = `status ${type}`;
        }

        function displayQuestions() {
            const display = document.getElementById('questionsDisplay');
            display.innerHTML = '';
            
            questionsList.forEach((q, index) => {
                const div = document.createElement('div');
                div.className = 'question-item';
                div.id = `question-${index}`;  // ADD THIS LINE
                div.textContent = `${index + 1}. ${q}`;
                display.appendChild(div);
            });
            updateStats();  // ADD THIS LINE
        }

        // Question loading functions
            function useDefaultQuestions() {
                questionsList = [
                    "who is the department head",
                    "who is the DAF",
                    "how can i create a budget?",
                    "how do i request a waiver",
                    "how do i request a proposal waiver",
                    "how do i request a waiver of search?",
                    "does the department still do waivers of search",
                    "where is Gabby Hoyte's office",
                    "who does Gabby Hoyte support?",
                    "who is the development officer?",
                    "who supports sertac karaman?"
                ];
                
                updateStatus('Loaded ${questionsList.length} default questions', 'success');
                addSystemMessage('‚úÖ Loaded ${questionsList.length} built-in questions');
                displayQuestions();
                updateStats();
                checkReadyToTest();
            }
            

        function loadFromTextArea() {
            const textarea = document.getElementById('questionTextArea');
            const text = textarea.value.trim();
            
            if (!text) {
                updateStatus('Please enter some questions in the text area', 'error');
                addMessage('‚ùå Text area is empty');
                return;
            }

            const questions = text.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);

            if (questions.length === 0) {
                updateStatus('No valid questions found', 'error');
                addMessage('‚ùå No valid questions found in text area');
                return;
            }

            questionsList = questions;
            updateStatus(`Loaded ${questionsList.length} questions from text area`, 'success');
            addMessage(`‚úÖ Loaded ${questionsList.length} questions from text area`);
            displayQuestions();
            updateStats();
            checkReadyToTest();
        }

        async function tryGoogleSheets() {
            const sheetId = document.getElementById('googleSheetId').value.trim();
            if (!sheetId) {
                updateStatus('Please enter a Google Sheet ID', 'error');
                return;
            }

            const btn = document.getElementById('googleBtn');
            const status = document.getElementById('googleStatus');
            
            btn.textContent = '‚è≥ Loading...';
            btn.disabled = true;
            status.textContent = `Trying to load from: ${sheetId}`;
            
            updateStatus('Attempting to load from Google Sheets...', 'warning');
            addMessage(`üîÑ Attempting to load from Google Sheet: ${sheetId}`);

            try {
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0`;
                addMessage(`üì° Fetching: ${url}`);
                
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 8000); // 8 second timeout
                
                const response = await fetch(url, {
                    signal: controller.signal,
                    mode: 'cors'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} - Sheet may not be published or accessible`);
                }

                const csvText = await response.text();
                if (!csvText.trim()) {
                    throw new Error('Empty response from Google Sheets');
                }

                const lines = csvText.split('\n');
                const questions = lines
                    .slice(1) // Skip header
                    .map(line => line.split(',')[0]) // First column
                    .filter(q => q && q.trim())
                    .map(q => q.replace(/"/g, '').trim());

                if (questions.length === 0) {
                    throw new Error('No questions found in first column');
                }

                questionsList = questions;
                updateStatus(`Loaded ${questionsList.length} questions from Google Sheets`, 'success');
                addMessage(`‚úÖ Successfully loaded ${questionsList.length} questions from Google Sheets`);
                status.textContent = `Success: ${questionsList.length} questions loaded`;
                displayQuestions();
                checkReadyToTest();

            } catch (error) {
                let errorMsg = error.message;
                if (error.name === 'AbortError') {
                    errorMsg = 'Timed out after 8 seconds';
                }
                
                updateStatus(`Google Sheets failed: ${errorMsg}`, 'error');
                addMessage(`‚ùå Google Sheets error: ${errorMsg}`);
                addMessage(`üí° Try copying questions manually instead`);
                status.textContent = `Failed: ${errorMsg}`;
            } finally {
                btn.textContent = 'üì• Try Google Sheets';
                btn.disabled = false;
            }
        }

        // Chatbot functions
        function loadChatbot() {
            const iframe = document.getElementById('chatIframe');
            iframe.src = 'https://aeroastrovfbot.netlify.app/chatbot.html';
            
            updateStatus('Loading chatbot with API interceptor...', 'warning');
            addSystemMessage('üîó Loading chatbot...');
            
            // The chatbot will send a CHATBOT_READY message when it's loaded
            // (handled by the message listener)
        }

        function checkReadyToTest() {
            const startBtn = document.getElementById('startBtn');
            if (questionsList.length > 0 && chatbotReady) {
                startBtn.disabled = false;
                updateStatus('Ready to start testing!', 'success');
            }
        }

        // Testing functions
        function startTest() {
            if (questionsList.length === 0) {
                updateStatus('Please load questions first', 'error');
                return;
            }
            if (!chatbotReady) {
                updateStatus('Please load chatbot first', 'error');
                return;
            }

            currentQuestionIndex = 0;
            qaResults = [];
            testRunning = true;
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('loadChatBtn').disabled = true;
            
            updateStatus('Testing in progress...', 'warning');
            addSystemMessage(`üöÄ Starting test with ${questionsList.length} questions`);
            updateStats();
            
            sendNextQuestion();
        }

       function sendNextQuestion() {
            if (currentQuestionIndex >= questionsList.length) {
                stopTest();
                updateStatus('All questions completed!', 'success');
                addSystemMessage('üéâ All questions completed!');
                return;
            }

            const question = questionsList[currentQuestionIndex];
            const questionNum = currentQuestionIndex + 1;
            
            // Update question display to show current
            document.querySelectorAll('.question-item').forEach(item => {
                item.classList.remove('current');
            });
            const currentItem = document.getElementById(`question-${currentQuestionIndex}`);
            if (currentItem) {
                currentItem.classList.add('current');
            }

            // Add to results as waiting
            qaResults.push({
                question: question,
                answer: 'WAITING',
                timestamp: new Date().toISOString()
            });

            updateTranscriptDisplay();
            
            try {
                const iframe = document.getElementById('chatIframe');
                const voiceflow = iframe.contentWindow.voiceflow;
                
                if (voiceflow && voiceflow.chat && voiceflow.chat.interact) {
                    waitingForResponse = true;
                    currentQuestionStartTime = Date.now();
                    
                    // Send the question
                    voiceflow.chat.interact({
                        type: 'text',
                        payload: question
                    });
                    
                    console.log(`Sent Q${questionNum}: ${question}`);
                    
                    // Set timeout in case response never comes
                    const maxWait = parseInt(document.getElementById('maxWaitSeconds').value) * 1000;
                    responseTimeout = setTimeout(() => {
                        if (waitingForResponse) {
                            console.log('Response timeout for question:', question);
                            qaResults[qaResults.length - 1].answer = '‚è±Ô∏è Timeout - no response received';
                            updateTranscriptDisplay();
                            waitingForResponse = false;
                            
                            setTimeout(() => {
                                if (testRunning) {
                                    sendNextQuestion();
                                }
                            }, 1000);
                        }
                    }, maxWait);
                    
                } else {
                    addSystemMessage('‚ùå Error: Cannot access Voiceflow in iframe');
                    qaResults[qaResults.length - 1].answer = 'Error: Voiceflow not accessible';
                    updateTranscriptDisplay();
                }
            } catch (error) {
                addSystemMessage(`‚ùå Error: ${error.message}`);
                qaResults[qaResults.length - 1].answer = `Error: ${error.message}`;
                updateTranscriptDisplay();
            }

            currentQuestionIndex++;
            
            // Mark previous as completed in display
            if (currentQuestionIndex > 1) {
                const prevItem = document.getElementById(`question-${currentQuestionIndex - 2}`);
                if (prevItem) {
                    prevItem.classList.remove('current');
                    prevItem.classList.add('completed');
                }
            }
        }


        function stopTest() {
            testRunning = false;
            waitingForResponse = false;
            
            if (responseTimeout) {
                clearTimeout(responseTimeout);
                responseTimeout = null;
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('loadChatBtn').disabled = false;
            
            updateStatus('Test stopped', 'info');
            addSystemMessage('‚èπÔ∏è Test stopped');
        }

        // Utility functions
        function clearTranscript() {
            qaResults = [];
            updateTranscriptDisplay();
            addSystemMessage('Transcript cleared');
        }

        function copyToClipboard() {
            let text = '=== VOICEFLOW TEST RESULTS ===\n\n';
            
            qaResults.forEach((qa, index) => {
                text += `Q${index + 1}: ${qa.question}\n`;
                text += `A${index + 1}: ${qa.answer}\n`;
                if (qa.responseTime) {
                    text += `Time: ${(qa.responseTime / 1000).toFixed(1)}s\n`;
                }
                text += '\n---\n\n';
            });
            
            navigator.clipboard.writeText(text).then(() => {
                addSystemMessage('üìã Transcript copied to clipboard');
            });
        }
        // ============================================
        // EXPORT TO CSV
        // ============================================
        function exportToCSV() {
            let csv = 'Question Number,Question,Answer,Response Time (seconds)\n';
            
            qaResults.forEach((qa, index) => {
                const question = qa.question.replace(/"/g, '""');
                const answer = qa.answer.replace(/"/g, '""');
                const time = qa.responseTime ? (qa.responseTime / 1000).toFixed(1) : 'N/A';
                csv += `${index + 1},"${question}","${answer}",${time}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `voiceflow-test-${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            
            addSystemMessage('üìä CSV exported successfully');
        }
        // Initialize
        window.addEventListener('load', () => {
            addSystemMessage('ü§ñ Chatbot Tester v3 Ready');
            addSystemMessage('‚ú® Using API interception for accurate responses');
            addSystemMessage('Step 1: Load questions');
            addSystemMessage('Step 2: Load chatbot');
            addSystemMessage('Step 3: Start testing');
        });
    </script>
</body>
</html>
