<!DOCTYPE html>
<html>
<head>
    <title>Simple Chatbot Tester</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .section { border: 2px solid #007bff; border-radius: 8px; padding: 20px; margin: 20px 0; background: #f8f9fa; }
        .section h3 { color: #007bff; margin-top: 0; }
        button { background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; margin: 5px; font-weight: bold; }
        button:hover { background: #0056b3; }
        button.green { background: #28a745; }
        button.red { background: #dc3545; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; margin: 5px 0; box-sizing: border-box; }
        textarea { height: 120px; font-family: monospace; }
        .status { padding: 15px; border-radius: 4px; margin: 15px 0; font-weight: bold; text-align: center; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        label { display: block; font-weight: bold; margin: 10px 0 5px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Simple Chatbot Tester</h1>
        
        <!-- GOOGLE SHEETS SECTION -->
        <div class="section">
            <h3>üìä METHOD 1: Load from Google Sheets</h3>
            
            <label>Google Sheet ID:</label>
            <input type="text" id="googleSheetId" placeholder="Enter your Google Sheet ID here" value="">
            
            <label>Sheet GID (optional - leave blank for first sheet):</label>
            <input type="text" id="sheetGid" placeholder="e.g. 123456789 (found in URL after #gid=)" value="">
            
            <button onclick="loadFromGoogleSheets()">üì• Load Questions from Google Sheets</button>
            
            <div id="googleStatus" style="margin: 10px 0; font-size: 12px; color: #666;">
                Enter your Google Sheet ID above and click the button
            </div>
        </div>
        
        <!-- MANUAL ENTRY SECTION -->
        <div class="section">
            <h3>‚úèÔ∏è METHOD 2: Manual Entry or Edit Questions</h3>
            
            <button onclick="loadDefaults()" class="green">üìù Load 5 Default Questions</button>
            
            <label>Questions (one per line):</label>
            <textarea id="questionsTextarea" placeholder="Enter your questions here, one per line...">What are the admission requirements?
How do I apply for financial aid?
What research opportunities are available?
Who should I contact about course registration?
What courses are required for the degree?</textarea>
            
            <button onclick="loadFromTextarea()">‚úÖ Use These Questions</button>
        </div>
        
        <!-- TESTING SECTION -->
        <div class="section">
            <h3>üöÄ Testing Controls</h3>
            
            <div class="status info" id="mainStatus">Ready - load questions using methods above</div>
            
            <label>Questions loaded: <span id="questionCount">5</span></label>
            <label>Delay between questions: <input type="number" id="delayInput" value="6" min="3" max="15" style="width: 60px;"> seconds</label>
            
            <button onclick="startTest()" id="startBtn">‚ñ∂Ô∏è Start Automated Test</button>
            <button onclick="stopTest()" id="stopBtn" class="red" disabled>‚èπÔ∏è Stop Test</button>
            <button onclick="exportCSV()" id="exportBtn" disabled>üíæ Export Results to CSV</button>
            
            <div style="margin: 15px 0;">
                <strong>Progress:</strong> <span id="progress">0/0</span>
                <div style="background: #e9ecef; height: 20px; border-radius: 4px; margin: 5px 0;">
                    <div id="progressBar" style="background: #007bff; height: 100%; border-radius: 4px; width: 0%; transition: width 0.3s;"></div>
                </div>
            </div>
        </div>
        
        <!-- CHATBOT SECTION -->
        <div class="section">
            <h3>üí¨ Chatbot (will load here)</h3>
            <div id="chatbotArea" style="height: 400px; border: 1px solid #ccc; border-radius: 4px; background: #fff;">
                <div style="padding: 20px; text-align: center; color: #666;">
                    Chatbot will load here when testing starts
                </div>
            </div>
        </div>
        
        <!-- RESULTS SECTION -->
        <div class="section">
            <h3>üìã Test Results</h3>
            <div id="resultsArea" style="height: 300px; border: 1px solid #ccc; border-radius: 4px; padding: 15px; overflow-y: auto; background: #fff; font-family: monospace; font-size: 12px;">
                Test results will appear here...
            </div>
            <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
        </div>
    </div>

    <script>
        let questions = ["What are the admission requirements?","How do I apply for financial aid?","What research opportunities are available?","Who should I contact about course registration?","What courses are required for the degree?"];
        let currentIndex = 0;
        let testResults = [];
        let testInterval = null;
        let chatbotLoaded = false;

        // Update question count display
        function updateQuestionCount() {
            document.getElementById('questionCount').textContent = questions.length;
            document.getElementById('progress').textContent = `${currentIndex}/${questions.length}`;
            const percentage = questions.length > 0 ? (currentIndex / questions.length) * 100 : 0;
            document.getElementById('progressBar').style.width = percentage + '%';
        }

        // Load from Google Sheets
        async function loadFromGoogleSheets() {
            const sheetId = document.getElementById('googleSheetId').value.trim();
            const gid = document.getElementById('sheetGid').value.trim() || '0';
            const statusDiv = document.getElementById('googleStatus');
            const mainStatus = document.getElementById('mainStatus');
            
            if (!sheetId) {
                statusDiv.textContent = '‚ùå Please enter a Google Sheet ID';
                statusDiv.style.color = 'red';
                return;
            }
            
            statusDiv.textContent = `üîÑ Loading from sheet ${sheetId}, GID: ${gid}...`;
            statusDiv.style.color = 'blue';
            mainStatus.textContent = 'Loading from Google Sheets...';
            mainStatus.className = 'status info';
            
            try {
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
                
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(url, { 
                    signal: controller.signal,
                    mode: 'cors' 
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} - Check that sheet is published and GID exists`);
                }
                
                const csvText = await response.text();
                if (!csvText.trim()) {
                    throw new Error('Empty response from Google Sheets');
                }
                
                const lines = csvText.split('\\n');
                const newQuestions = lines
                    .slice(1) // Skip header
                    .map(line => line.split(',')[0]) // First column
                    .filter(q => q && q.trim())
                    .map(q => q.replace(/"/g, '').trim());
                
                if (newQuestions.length === 0) {
                    throw new Error('No questions found in first column');
                }
                
                questions = newQuestions;
                document.getElementById('questionsTextarea').value = questions.join('\\n');
                updateQuestionCount();
                
                statusDiv.textContent = `‚úÖ Successfully loaded ${questions.length} questions`;
                statusDiv.style.color = 'green';
                mainStatus.textContent = `Google Sheets: Loaded ${questions.length} questions successfully`;
                mainStatus.className = 'status success';
                
            } catch (error) {
                let errorMsg = error.message;
                if (error.name === 'AbortError') {
                    errorMsg = 'Timed out after 10 seconds';
                }
                
                statusDiv.textContent = `‚ùå Failed: ${errorMsg}`;
                statusDiv.style.color = 'red';
                mainStatus.textContent = `Google Sheets error: ${errorMsg}`;
                mainStatus.className = 'status error';
            }
        }

        // Load default questions
        function loadDefaults() {
            const defaults = [
                "What are the admission requirements?",
                "How do I apply for financial aid?", 
                "What research opportunities are available?",
                "Who should I contact about course registration?",
                "What courses are required for the aerospace engineering degree?"
            ];
            
            document.getElementById('questionsTextarea').value = defaults.join('\\n');
            questions = defaults;
            updateQuestionCount();
            
            const mainStatus = document.getElementById('mainStatus');
            mainStatus.textContent = `Loaded ${questions.length} default questions`;
            mainStatus.className = 'status success';
        }

        // Load from textarea
        function loadFromTextarea() {
            const textarea = document.getElementById('questionsTextarea');
            const newQuestions = textarea.value.split('\\n').filter(q => q.trim());
            
            if (newQuestions.length === 0) {
                const mainStatus = document.getElementById('mainStatus');
                mainStatus.textContent = 'Please enter some questions in the text area';
                mainStatus.className = 'status error';
                return;
            }
            
            questions = newQuestions;
            updateQuestionCount();
            
            const mainStatus = document.getElementById('mainStatus');
            mainStatus.textContent = `Loaded ${questions.length} questions from text area`;
            mainStatus.className = 'status success';
        }

        // Start test
        function startTest() {
            if (questions.length === 0) {
                alert('Please load some questions first!');
                return;
            }
            
            currentIndex = 0;
            testResults = [];
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('exportBtn').disabled = true;
            
            const mainStatus = document.getElementById('mainStatus');
            mainStatus.textContent = 'Test in progress...';
            mainStatus.className = 'status info';
            
            addResult('üöÄ Starting automated test...', 'system');
            addResult(`üìù Testing ${questions.length} questions with ${document.getElementById('delayInput').value}s delays`, 'system');
            
            // Load chatbot
            loadChatbot();
            
            // Start sending questions
            setTimeout(() => {
                sendNextQuestion();
                const delay = parseInt(document.getElementById('delayInput').value) * 1000;
                testInterval = setInterval(sendNextQuestion, delay);
            }, 5000); // Wait 5 seconds for chatbot to load
        }

        // Load chatbot iframe
        function loadChatbot() {
            document.getElementById('chatbotArea').innerHTML = 
                '<iframe src="https://aeroastrovfbot.netlify.app/chatbot.html" style="width: 100%; height: 100%; border: none;"></iframe>';
            chatbotLoaded = true;
        }

        // Send next question
        function sendNextQuestion() {
            if (currentIndex >= questions.length) {
                stopTest();
                const mainStatus = document.getElementById('mainStatus');
                mainStatus.textContent = 'All questions completed!';
                mainStatus.className = 'status success';
                document.getElementById('exportBtn').disabled = false;
                addResult('‚úÖ All questions completed!', 'system');
                return;
            }
            
            const question = questions[currentIndex];
            const qNum = currentIndex + 1;
            
            addResult(`Q${qNum}: ${question}`, 'question');
            addResult(`A${qNum}: [Response captured - see chatbot]`, 'answer');
            
            testResults.push({
                question: question,
                answer: '[Response from chatbot]',
                timestamp: new Date().toISOString()
            });
            
            currentIndex++;
            updateQuestionCount();
        }

        // Stop test
        function stopTest() {
            if (testInterval) {
                clearInterval(testInterval);
                testInterval = null;
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            if (testResults.length > 0) {
                document.getElementById('exportBtn').disabled = false;
            }
            
            const mainStatus = document.getElementById('mainStatus');
            mainStatus.textContent = 'Test stopped';
            mainStatus.className = 'status info';
            
            addResult('‚èπÔ∏è Test stopped', 'system');
        }

        // Add result to display
        function addResult(message, type) {
            const resultsArea = document.getElementById('resultsArea');
            const time = new Date().toLocaleTimeString();
            const colors = {
                system: '#666',
                question: '#007bff', 
                answer: '#28a745'
            };
            
            resultsArea.innerHTML += `<div style="color: ${colors[type] || '#333'}; margin: 5px 0;">[${time}] ${message}</div>`;
            resultsArea.scrollTop = resultsArea.scrollHeight;
        }

        // Export CSV
        function exportCSV() {
            if (testResults.length === 0) {
                alert('No results to export!');
                return;
            }
            
            const csv = [
                'Question,Answer,Timestamp',
                ...testResults.map(r => 
                    `"${r.question.replace(/"/g, '""')}","${r.answer.replace(/"/g, '""')}","${r.timestamp}"`
                )
            ].join('\\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chatbot-test-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            addResult('üìÑ Results exported to CSV', 'system');
        }

        // Clear results
        function clearResults() {
            document.getElementById('resultsArea').innerHTML = 'Results cleared...';
            testResults = [];
            document.getElementById('exportBtn').disabled = true;
        }

        // Initialize
        window.addEventListener('load', () => {
            updateQuestionCount();
        });
    </script>
</body>
</html>
