<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AeroAstro Bot - User Access Admin</title>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(to bottom, #001a2e 0%, #003d5c 50%, #4a90b8 100%);
        color: #333;
        line-height: 1.6;
        min-height: 100vh;
    }
    
    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        background: white;
        min-height: 100vh;
    }
    
    .header {
        background: linear-gradient(135deg, #003d5c 0%, #1e5a7a 50%, #4a90b8 100%);
        color: white;
        padding: 30px 40px;
        margin: -20px -20px 30px -20px;
        border-bottom: 4px solid #003d5c;
        position: relative;
        overflow: hidden;
    }
    
    .header h1 {
        font-size: 2.2em;
        font-weight: 600;
        margin-bottom: 10px;
    }
    
    .header p {
        font-size: 1.1em;
        opacity: 0.95;
        font-weight: 300;
    }
    
    .header-logo {
        position: absolute;
        top: 50%;
        right: 40px;
        transform: translateY(-50%);
        height: 60px;
        width: auto;
        opacity: 0.9;
    }
    
    .quick-links {
        position: absolute;
        top: 30px;
        right: 40px;
    }
    
    .quick-links h3 {
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
        opacity: 0.9;
    }
    
    .quick-links ul {
        list-style: none;
    }
    
    .quick-links a {
        color: white;
        text-decoration: none;
        font-size: 0.9em;
        opacity: 0.85;
        transition: opacity 0.3s ease;
    }
    
    .quick-links a:hover {
        opacity: 1;
        text-decoration: underline;
    }
    
    h2 {
        color: #003d5c;
        font-size: 1.8em;
        margin: 30px 0 20px 0;
        padding-bottom: 10px;
        border-bottom: 3px solid #003d5c;
    }
    
    .section {
        margin-bottom: 40px;
        padding: 25px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #003d5c;
    }
    
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.95em;
        font-weight: 500;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .btn-primary {
        background: #003d5c;
        color: white;
    }
    
    .btn-primary:hover {
        background: #002a40;
    }
    
    .btn-success {
        background: #27ae60;
        color: white;
    }
    
    .btn-success:hover {
        background: #229954;
    }
    
    .btn-danger {
        background: #e74c3c;
        color: white;
    }
    
    .btn-danger:hover {
        background: #c0392b;
    }
    
    .btn-info {
        background: #3498db;
        color: white;
    }
    
    .btn-info:hover {
        background: #2980b9;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    label {
        display: block;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
        font-size: 0.95em;
    }
    
    /* Tooltip styles */
    .label-with-tooltip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        position: relative;
    }
    
    .tooltip-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        background: #003d5c;
        color: white;
        border-radius: 50%;
        font-size: 11px;
        font-weight: bold;
        cursor: help;
        position: relative;
    }
    
    .tooltip-text {
        visibility: hidden;
        width: 220px;
        background-color: #2c3e50;
        color: white;
        text-align: center;
        border-radius: 6px;
        padding: 8px;
        position: absolute;
        z-index: 1001;
        bottom: 125%;
        left: 50%;
        margin-left: -110px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.85em;
        font-weight: normal;
        line-height: 1.4;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #2c3e50 transparent transparent transparent;
    }
    
    .tooltip-icon:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }
    
    input[type="text"],
    input[type="email"],
    textarea {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 0.95em;
        transition: all 0.3s ease;
    }
    
    input[type="text"]:focus,
    input[type="email"]:focus,
    textarea:focus {
        outline: none;
        border-color: #003d5c;
        box-shadow: 0 0 0 3px rgba(0, 61, 92, 0.1);
    }
    
    input[type="checkbox"] {
        margin-right: 8px;
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    textarea {
        resize: vertical;
        min-height: 100px;
    }
    
    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-top: 20px;
    }
    
    thead {
        background: linear-gradient(to right, #003d5c, #1e5a7a, #4a90b8);
        color: white;
    }
    
    th {
        padding: 16px 12px;
        text-align: left;
        font-weight: 600;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    tbody tr {
        border-bottom: 1px solid #ecf0f1;
        transition: all 0.2s ease;
    }
    
    tbody tr:hover {
        background: #f8f9fa;
    }
    
    td {
        padding: 14px 12px;
        font-size: 0.95em;
    }
    
    .badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        text-transform: uppercase;
        display: inline-block;
    }
    
    .badge-yes {
        background: #d4edda;
        color: #155724;
    }
    
    .badge-no {
        background: #f8d7da;
        color: #721c24;
    }
    
    #statusMessage {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 2000;
        display: none;
        font-weight: 500;
    }
    
    .status-success {
        background: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
    }
    
    .status-error {
        background: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
    }
    
    #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px 40px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 2000;
        display: none;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #003d5c;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Action Buttons Dropdown */
    .action-cell {
        position: relative;
    }

    .action-dropdown {
        position: relative;
        display: inline-block;
    }

    .action-btn {
        padding: 8px 16px;
        background: #003d5c;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }

    .action-btn:hover {
        background: #002a40;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        bottom: 100%; /* Open upward by default to prevent clipping */
        background: white;
        min-width: 180px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: 6px;
        z-index: 1000;
        overflow: visible;
        margin-bottom: 5px;
    }

    /* For rows at the top of the table, open downward instead */
    tbody tr:nth-child(-n+2) .dropdown-content {
        bottom: auto;
        top: 100%;
        margin-top: 5px;
        margin-bottom: 0;
    }

    .action-dropdown:hover .dropdown-content,
    .dropdown-content:hover {
        display: block;
    }

    .dropdown-item {
        padding: 12px 16px;
        border: none;
        width: 100%;
        text-align: left;
        background: white;
        cursor: pointer;
        font-size: 0.9em;
        transition: background 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .dropdown-item:hover {
        background: #f8f9fa;
    }

    .dropdown-item.grant {
        color: #27ae60;
    }

    .dropdown-item.grant:hover {
        background: #d4edda;
    }

    .dropdown-item.remove {
        color: #e74c3c;
    }

    .dropdown-item.remove:hover {
        background: #f8d7da;
    }

    .dropdown-item.delete {
        color: #c0392b;
        border-top: 1px solid #ecf0f1;
    }

    .dropdown-item.delete:hover {
        background: #f8d7da;
    }
</style>
</head>
<body>
    <div class="container">
<div class="header">
    <h1>AeroAstro Bot - User Access Administration</h1>
    <p>Manage user access permissions for the chatbot system</p>
    <img src="AO-logo-low_color-left.png" alt="AeroAstro Logo" class="header-logo">
    <div class="quick-links">
                <h4>Quick Links</h4>
                <ul>
                    <li><a href="https://aeroastrovfbot.netlify.app/simple-tester.html" target="_blank">Auto Tester</a></li>
                    <li><a href="https://mit.quickbase.com/nav/main/action/myqb" target="_blank">QuickBase</a></li>
                    <li><a href="https://app.netlify.com/projects/aeroastrovfbot/deploys" target="_blank">Netlify Deploy</a></li>
                    <li><a href="https://us2.make.com/62284/scenarios/2987098/edit" target="_blank">Make.com Scenario</a></li>
                    <li><a href="https://github.com/boconaillMIT/Voiceflow.AeroAstro.io/blob/main/admin.html" target="_blank">GitHub Repository</a></li>

                </ul>
            </div>
        </div>

        <!-- Authentication Section -->
        <div class="auth-section" id="authSection">
            <h3>Administrator Authentication</h3>
            <p>Verifying your credentials automatically...</p>
            <div id="authLoading" class="loading">
                <div class="spinner"></div>
                <p>Checking authentication...</p>
            </div>
            <div id="authMessage" class="status-message"></div>
        </div>

        <!-- Admin Panel (hidden by default) -->
        <div class="admin-panel" id="adminPanel">
            <div class="section">
                <h2>User Management</h2>
           
                <div class="section">
                    <a href="reviewAI.html" class="btn btn-success" style="display: inline-block; text-decoration: none; margin-bottom: 20px; margin-right: 15px;">
                        📝 Review AI KB Submissions
                    </a>
                    <a href="reviewAIQA.html" class="btn btn-success" style="display: inline-block; text-decoration: none; margin-bottom: 20px;">
                        🧪 Review AI Q&A Submissions
                    </a>
                </div>
                <!-- Status Messages -->
                <div id="statusMessage" class="status-message"></div>
                
                <!-- Loading Indicator -->
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>Loading...</p>
                </div>

                <!-- User List (MOVED BEFORE Add New User) -->
                <div class="section">
                    <h3>Current Users</h3>
                    <button class="btn" onclick="loadUsers()">Refresh User List</button>
                    <table id="userTable">
                        <thead>
                            <tr>
                                <th>Kerberos ID</th>
                                <th>Department</th>
                                <th>Exception User</th>
                                <th>Administrator</th>
                                <th>Login Count</th>
                                <th>Last Login</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <!-- User data will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Add New User Form (MOVED AFTER User List) -->
                <div class="section">
                    <h3>Add New Exception User</h3>
                    <form id="addUserForm">
                        <div class="form-group">
                            <label for="newKerberos">Kerberos ID:</label>
                            <input type="text" id="newKerberos" required>
                        </div>
                        <div class="form-group">
                            <label for="newDepartment">Department:</label>
                            <input type="text" id="newDepartment" required>
                        </div>
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="newIsException" checked>
                            <label for="newIsException" class="label-with-tooltip">
                                Grant Exception Access
                                <span class="tooltip-icon">?
                                    <span class="tooltip-text">To grant access to non-AeroAstro users</span>
                                </span>
                            </label>
                        </div>
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="newIsAdmin">
                            <label for="newIsAdmin">Grant Administrator Privileges</label>
                        </div>
                        <div class="form-group">
                            <label for="newNotes">Notes (reason for access):</label>
                            <textarea id="newNotes" placeholder="Enter reason for granting access..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">Add User</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const QUICKBASE_CONFIG = {
            realm: 'mit.quickbase.com',
            appId: 'buuhxhtmv',
            tableId: 'bve87f9um',
            userTableId: 'bve87f9um', 
            userToken: 'b4bqn2_bkcg_0_cjj8hwibg9qrcyx9fm2qiqa5h'
        };

        // Simple authentication
        async function authenticateUser() {
            console.log('Starting authentication...');
            
            try {
                const storedData = localStorage.getItem('user_metadata');
                if (!storedData) {
                    showError('No authentication data found. Please login to the chatbot first.');
                    return false;
                }
                
                const userData = JSON.parse(storedData);
                console.log('Found user data for:', userData.kerberos);
                
                // Query QuickBase directly to check admin status
                const queryBody = {
                    from: QUICKBASE_CONFIG.userTableId,  // 'bve87f9um'
                    select: [3, 6, 7, 8, 14],  // Include field 14 (Administrator)
                    where: `{6.EX.'${userData.kerberos}'}`  // Find user by kerberos ID
                };
                
                console.log('Checking admin status in QuickBase for:', userData.kerberos);
                
                const response = await makeQuickBaseRequest('POST', 'records/query', queryBody);
                
                if (!response.data || response.data.length === 0) {
                    showError('User not found in database: ' + userData.kerberos);
                    return false;
                }
                
                const userRecord = response.data[0];
                const isAdmin = userRecord[14]?.value === true || 
                               userRecord[14]?.value === 'true' || 
                               userRecord[14]?.value === 1 || 
                               userRecord[14]?.value === '1';
                
                console.log('Admin field value:', userRecord[14]?.value, 'isAdmin:', isAdmin);
                
                if (isAdmin) {
                    showSuccess('Admin access granted for ' + userData.kerberos);
                    return true;
                } else {
                    showError('Access denied. User ' + userData.kerberos + ' does not have administrator privileges.');
                    return false;
                }
                
            } catch (error) {
                console.error('Auth error:', error);
                showError('Authentication error: ' + error.message);
                return false;
            }
        }
        
        function showSuccess(message) {
            document.getElementById('authLoading').style.display = 'none';
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            console.log('Success:', message);
        }
        
        function showError(message) {
            document.getElementById('authLoading').style.display = 'none';
            const authMessage = document.getElementById('authMessage');
            authMessage.textContent = message;
            authMessage.className = 'status-message status-error';
            authMessage.style.display = 'block';
            console.log('Error:', message);
        }

        function showAuthMessage(message, type) {
            const authMessage = document.getElementById('authMessage');
            authMessage.textContent = message;
            authMessage.className = `status-message status-${type}`;
            authMessage.style.display = 'block';
        }

        function showMessage(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.style.display = 'block';
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // QuickBase API functions
        async function makeQuickBaseRequest(method, endpoint, body) {
            const url = `https://api.quickbase.com/v1/${endpoint}`;
            const headers = {
                'QB-Realm-Hostname': QUICKBASE_CONFIG.realm,
                'Authorization': `QB-USER-TOKEN ${QUICKBASE_CONFIG.userToken}`,
                'Content-Type': 'application/json'
            };

            try {
                console.log(`Making ${method} request to: ${url}`);
                console.log('Request body:', body ? JSON.stringify(body, null, 2) : 'No body');
                
                const response = await fetch(url, {
                    method: method,
                    headers: headers,
                    body: body ? JSON.stringify(body) : null
                });

                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error text:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const result = await response.json();
                console.log('Response result:', result);
                return result;
            } catch (error) {
                console.error('QuickBase API error:', error);
                throw error;
            }
        }

        async function loadUsers() {
            showLoading(true);
            try {
                const response = await makeQuickBaseRequest('POST', 'records/query', {
                    from: QUICKBASE_CONFIG.tableId,
                    select: [3, 6, 7, 8, 9, 10, 11, 13, 14], // Include field 14 (Is Administrator)
                    options: {
                        orderBy: [{ fieldId: 6, order: 'ASC' }]
                    }
                });

                console.log('Raw user data from QuickBase:', response.data);
                displayUsers(response.data);
                showMessage('User list loaded successfully', 'success');
            } catch (error) {
                console.error('Load users error:', error);
                showMessage('Error loading users: ' + error.message, 'error');
                
                // If field 14 doesn't exist, try without it
                try {
                    console.log('Retrying without field 14...');
                    const retryResponse = await makeQuickBaseRequest('POST', 'records/query', {
                        from: QUICKBASE_CONFIG.tableId,
                        select: [3, 6, 7, 8, 9, 10, 11, 13], // Without field 14
                        options: {
                            orderBy: [{ fieldId: 6, order: 'ASC' }]
                        }
                    });
                    
                    console.log('Retry successful, field 14 (Is Administrator) may not exist in QuickBase');
                    displayUsers(retryResponse.data);
                    showMessage('User list loaded (Note: Administrator field may not exist in QuickBase)', 'success');
                } catch (retryError) {
                    showMessage('Error loading users even without admin field: ' + retryError.message, 'error');
                }
            } finally {
                showLoading(false);
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';
            users.forEach(user => {
                const row = tbody.insertRow();
                
                const isException = user[8]?.value || false;
                const isAdmin = user[14]?.value || false;
                const recordId = user[3].value;
                const kerberos = user[6]?.value || '';
                
                row.innerHTML = `
                    <td>${kerberos}</td>
                    <td>${user[7]?.value || ''}</td>
                    <td>${isException ? 'Yes' : 'No'}</td>
                    <td>${isAdmin ? 'Yes' : 'No'}</td>
                    <td>${user[11]?.value || 0}</td>
                    <td>${user[10]?.value ? new Date(user[10].value).toLocaleDateString() : 'Never'}</td>
                    <td>${user[13]?.value || ''}</td>
                    <td class="action-cell">
                        <div class="action-dropdown">
                            <button class="action-btn">
                                Actions ▼
                            </button>
                            <div class="dropdown-content">
                                ${isException 
                                    ? `<button class="dropdown-item remove" onclick="toggleExceptionAccess(${recordId}, true)">✗ Remove Exception</button>`
                                    : `<button class="dropdown-item grant" onclick="toggleExceptionAccess(${recordId}, false)">✓ Grant Exception</button>`
                                }
                                ${isAdmin 
                                    ? `<button class="dropdown-item remove" onclick="toggleAdminAccess(${recordId}, true)">✗ Remove Admin</button>`
                                    : `<button class="dropdown-item grant" onclick="toggleAdminAccess(${recordId}, false)">✓ Grant Admin</button>`
                                }
                                <button class="dropdown-item delete" onclick="deleteUser(${recordId}, '${kerberos}')">🗑️ Delete User</button>
                            </div>
                        </div>
                    </td>
                `;
            });
        }

        async function addUser() {
            const kerberos = document.getElementById('newKerberos').value.trim();
            const department = document.getElementById('newDepartment').value.trim();
            const isException = document.getElementById('newIsException').checked;
            const isAdmin = document.getElementById('newIsAdmin').checked;
            const notes = document.getElementById('newNotes').value.trim();

            if (!kerberos || !department) {
                showMessage('Please fill in all required fields', 'error');
                return;
            }

            showLoading(true);
            try {
                await makeQuickBaseRequest('POST', 'records', {
                    to: QUICKBASE_CONFIG.tableId,
                    data: [{
                        6: { value: kerberos },
                        7: { value: department },
                        8: { value: isException },
                        9: { value: new Date().toISOString() },
                        10: { value: new Date().toISOString() },
                        11: { value: 0 },
                        13: { value: notes },
                        14: { value: isAdmin }
                    }]
                });

                showMessage('User added successfully', 'success');
                document.getElementById('addUserForm').reset();
                document.getElementById('newIsException').checked = true;
                document.getElementById('newIsAdmin').checked = false;
                loadUsers();
            } catch (error) {
                showMessage('Error adding user: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function toggleAdminAccess(recordId, currentStatus) {
            const newStatus = !currentStatus;
            const action = newStatus ? 'grant' : 'remove';
            
            if (!confirm(`Are you sure you want to ${action} administrator privileges for this user?`)) {
                return;
            }

            showLoading(true);
            try {
                // First, get the Kerberos ID for this record since that's the key field
                console.log('Getting Kerberos ID for record:', recordId);
                
                const recordData = await makeQuickBaseRequest('POST', 'records/query', {
                    from: QUICKBASE_CONFIG.tableId,
                    select: [3, 6, 14], // Record ID, Kerberos ID, Admin field
                    where: `{3.EX.${recordId}}`
                });
                
                if (!recordData.data || recordData.data.length === 0) {
                    throw new Error('Record not found');
                }
                
                const kerberosId = recordData.data[0][6]?.value;
                console.log('Found Kerberos ID:', kerberosId);
                
                if (!kerberosId) {
                    throw new Error('Kerberos ID not found for this record');
                }
                
                // Now update using Kerberos ID as the key field (field 6)
                const updatePayload = {
                    to: QUICKBASE_CONFIG.tableId,
                    data: [{
                        "6": {"value": kerberosId},  // Kerberos ID as key field
                        "14": {"value": newStatus}   // Admin field to update
                    }]
                };
                
                console.log('Admin update payload (using Kerberos key):', JSON.stringify(updatePayload, null, 2));
                
                const response = await makeQuickBaseRequest('POST', 'records', updatePayload);
                console.log('Admin update response:', response);
                
                showMessage(`Administrator privileges ${newStatus ? 'granted' : 'removed'} successfully`, 'success');
                await loadUsers();
                
            } catch (error) {
                console.error('Admin update error:', error);
                showMessage('Error updating admin privileges: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function toggleExceptionAccess(recordId, currentStatus) {
            const newStatus = !currentStatus;
            const action = newStatus ? 'grant' : 'remove';
            
            if (!confirm(`Are you sure you want to ${action} exception access for this user?`)) {
                return;
            }

            showLoading(true);
            try {
                // First, get the Kerberos ID for this record since that's the key field
                console.log('Getting Kerberos ID for record:', recordId);
                
                const recordData = await makeQuickBaseRequest('POST', 'records/query', {
                    from: QUICKBASE_CONFIG.tableId,
                    select: [3, 6, 8], // Record ID, Kerberos ID, Exception field
                    where: `{3.EX.${recordId}}`
                });
                
                if (!recordData.data || recordData.data.length === 0) {
                    throw new Error('Record not found');
                }
                
                const kerberosId = recordData.data[0][6]?.value;
                console.log('Found Kerberos ID:', kerberosId);
                
                if (!kerberosId) {
                    throw new Error('Kerberos ID not found for this record');
                }
                
                // Now update using Kerberos ID as the key field (field 6)
                const updatePayload = {
                    to: QUICKBASE_CONFIG.tableId,
                    data: [{
                        "6": {"value": kerberosId},  // Kerberos ID as key field
                        "8": {"value": newStatus}    // Exception field to update
                    }]
                };
                
                console.log('Exception update payload (using Kerberos key):', JSON.stringify(updatePayload, null, 2));
                
                const response = await makeQuickBaseRequest('POST', 'records', updatePayload);
                console.log('Exception update response:', response);
                
                showMessage(`Exception access ${newStatus ? 'granted' : 'removed'} successfully`, 'success');
                await loadUsers();
                
            } catch (error) {
                console.error('Exception update error:', error);
                showMessage('Error updating exception access: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteUser(recordId, kerberosId) {
            if (!confirm(`Are you sure you want to delete user "${kerberosId}"? This action cannot be undone.`)) {
                return;
            }

            showLoading(true);
            try {
                // Use the correct delete syntax for QuickBase API
                const deletePayload = {
                    from: QUICKBASE_CONFIG.tableId,
                    where: `{3.EX.${recordId}}`
                };
                
                console.log('Delete payload:', JSON.stringify(deletePayload, null, 2));
                
                const response = await makeQuickBaseRequest('DELETE', 'records', deletePayload);
                console.log('Delete response:', response);
                
                showMessage('User deleted successfully', 'success');
                await loadUsers();
            } catch (error) {
                console.error('Delete error:', error);
                
                // Try alternative delete method
                try {
                    console.log('Trying alternative delete method...');
                    const altResponse = await makeQuickBaseRequest('POST', 'records/query', {
                        from: QUICKBASE_CONFIG.tableId,
                        select: [3],
                        where: `{3.EX.${recordId}}`
                    });
                    
                    if (altResponse.data.length > 0) {
                        // Record exists, try direct DELETE to specific record
                        const directDeleteResponse = await fetch(`https://api.quickbase.com/v1/records/${recordId}?tableId=${QUICKBASE_CONFIG.tableId}`, {
                            method: 'DELETE',
                            headers: {
                                'QB-Realm-Hostname': QUICKBASE_CONFIG.realm,
                                'Authorization': `QB-USER-TOKEN ${QUICKBASE_CONFIG.userToken}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (directDeleteResponse.ok) {
                            showMessage('User deleted successfully', 'success');
                            await loadUsers();
                        } else {
                            throw new Error('Failed to delete user using direct method');
                        }
                    } else {
                        showMessage('User not found or already deleted', 'error');
                    }
                } catch (altError) {
                    showMessage('Error deleting user: ' + error.message, 'error');
                }
            } finally {
                showLoading(false);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, starting auth...');
            if (authenticateUser()) {
                loadUsers();
            }
        });

        // Form submission handler
        document.getElementById('addUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            addUser();
        });
    </script>
</body>
</html>
