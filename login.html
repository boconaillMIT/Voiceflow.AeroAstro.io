<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AeroAstro Chatbot Login</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 600px;
      margin: 100px auto;
      padding: 20px;
      background-color: #f8f9fa;
      text-align: center;
    }
    .login-container {
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 28px;
      font-weight: 600;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 16px;
    }
    .loading {
      color: #667eea;
      font-size: 18px;
      margin-top: 20px;
    }
    .error-message {
      color: #e74c3c;
      font-size: 16px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="login-container">
    <h2>AeroAstro Chatbot</h2>
    <p class="subtitle">Secure login via MIT Touchstone</p>
    <div class="loading" id="status">Initializing login...</div>
  </div>

  <script>
    // Base64URL encoding helper
    function base64UrlEncode(arrayBuffer) {
      const bytes = new Uint8Array(arrayBuffer);
      let binary = '';
      for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    // Generate PKCE verifier
    function generateVerifier() {
      const array = new Uint8Array(56);
      crypto.getRandomValues(array);
      return btoa(String.fromCharCode(...array)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    // Generate PKCE challenge
    async function generateChallenge(verifier) {
      try {
        const encoder = new TextEncoder();
        const data = encoder.encode(verifier);
        const digest = await crypto.subtle.digest('SHA-256', data);
        return base64UrlEncode(digest);
      } catch (error) {
        throw error;
      }
    }

    // Start OAuth login flow
    async function startLogin() {
      try {
        // Check if user already has OAuth data
        const existingData = localStorage.getItem('user_metadata');
        const urlParams = new URLSearchParams(window.location.search);
        
        if (existingData && !urlParams.get('force_login')) {
          document.getElementById('status').textContent = 'Already authenticated - redirecting...';
          setTimeout(() => {
            window.location.href = 'chatbot.html';
          }, 2000);
          return;
        }

        // Generate PKCE parameters
        const verifier = generateVerifier();
        const challenge = await generateChallenge(verifier);
        const state = Math.random().toString(36).substring(2);

        // Store for callback verification
        localStorage.setItem('pkce_verifier', verifier);
        localStorage.setItem('pkce_state', state);

        // Verify storage
        const storedVerifier = localStorage.getItem('pkce_verifier');
        const storedState = localStorage.getItem('pkce_state');
        
        if (!storedVerifier || !storedState) {
          throw new Error('Failed to store authentication data');
        }

        // Build OAuth authorization URL
        const params = new URLSearchParams({
          client_id: '0oau3bha34MtNzb6U697',
          response_type: 'code',
          scope: 'openid profile email',
          redirect_uri: 'https://aeroastrovfbot.netlify.app/callback.html',
          state: state,
          nonce: Math.random().toString(36).slice(2),
          code_challenge_method: 'S256',
          code_challenge: challenge,
        });

        const authUrl = `https://mitprod.okta.com/oauth2/default/v1/authorize?${params.toString()}`;

        // Update status and redirect
        document.getElementById('status').textContent = 'Redirecting to MIT authentication...';
        
        setTimeout(() => {
          window.location.href = authUrl;
        }, 2000);

      } catch (error) {
        document.getElementById('status').textContent = 'Login failed. Please refresh the page to try again.';
        document.getElementById('status').className = 'error-message';
        console.error('Login error:', error);
      }
    }

    // Start the login process
    startLogin();
  </script>
</body>
</html>
