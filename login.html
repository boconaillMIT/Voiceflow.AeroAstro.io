<!DOCTYPE html>
<html>
<head><title>Login with MIT Okta</title></head>
<body>
<h2>Redirecting to MIT SSO...</h2>
<script>
  async function generateVerifier() {
    const array = new Uint8Array(56);
    crypto.getRandomValues(array);
    return btoa(String.fromCharCode(...array))
      .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  }

  async function generateChallenge(verifier) {
    const encoder = new TextEncoder();
    const data = encoder.encode(verifier);
    const digest = await crypto.subtle.digest('SHA-256', data);
    const base64 = btoa(String.fromCharCode(...new Uint8Array(digest)));
    return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  }

  async function login() {
    const verifier = await generateVerifier();
    const challenge = await generateChallenge(verifier);

    // Save verifier locally if you want
    localStorage.setItem('pkce_verifier', verifier);

    // Use the verifier itself as the 'state' parameter (URL-encoded)
    const state = encodeURIComponent(verifier);

    const params = new URLSearchParams({
      client_id: 'YOUR_CLIENT_ID',
      response_type: 'code',
      scope: 'openid profile email',
      redirect_uri: 'https://aeroastrovfbot.netlify.app/.netlify/functions/oidc-callback',
      state: state,
      nonce: Math.random().toString(36).slice(2),
      code_challenge_method: 'S256',
      code_challenge: challenge,
    });

    window.location.href = `https://YOUR_OKTA_DOMAIN/oauth2/default/v1/authorize?${params.toString()}`;
  }

  login();
</script>
</body>
</html>
