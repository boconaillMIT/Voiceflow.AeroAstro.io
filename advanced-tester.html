<!DOCTYPE html>
<html>
<head>
    <title>Complete Chatbot Tester</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .container {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            height: calc(100vh - 120px);
        }
        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .panel-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
            color: #495057;
        }
        .panel-content {
            padding: 20px;
            height: calc(100% - 60px);
            overflow-y: auto;
        }
        .chatbot-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 0;
            width: 100%;
            font-size: 13px;
            font-weight: bold;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.green { background: #28a745; }
        button.red { background: #dc3545; }
        button.orange { background: #fd7e14; }
        textarea {
            width: 100%;
            height: 120px;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            box-sizing: border-box;
            resize: vertical;
        }
        input[type="number"] {
            width: 60px;
            padding: 5px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin: 0 5px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
            text-align: center;
            font-size: 12px;
        }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        .conversation {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .message {
            margin: 8px 0;
            padding: 8px;
            border-radius: 6px;
        }
        .message.user {
            background: #007bff;
            color: white;
            margin-left: 20%;
        }
        .message.bot {
            background: #e9ecef;
            color: #333;
            margin-right: 20%;
        }
        .message.system {
            background: #fff3cd;
            color: #856404;
            text-align: center;
            font-style: italic;
        }
        .progress-bar {
            background: #e9ecef;
            border-radius: 4px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            background: #007bff;
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: bold;
        }
        .questions-list {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 150px;
            overflow-y: auto;
            font-size: 11px;
        }
        .question-item {
            padding: 4px;
            margin: 2px 0;
            border-radius: 3px;
            background: white;
        }
        .question-item.current {
            background: #007bff;
            color: white;
        }
        .question-item.completed {
            background: #28a745;
            color: white;
        }
        .chatbot-embed {
            width: 100%;
            height: 100%;
            border: none;
            position: relative;
        }
        .embed-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
        }
        label {
            display: block;
            margin: 8px 0 4px 0;
            font-weight: bold;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü§ñ Complete Chatbot Tester</h1>
        <p>Full conversation capture with questions and answers - No console required!</p>
    </div>

    <div class="container">
        <!-- Left Panel: Controls -->
        <div class="panel">
            <div class="panel-header">‚öôÔ∏è Test Controls</div>
            <div class="panel-content">
                
                <button onclick="loadDefaultQuestions()" class="green">üìù Load Default Questions</button>
                
                <label>Questions (one per line):</label>
                <textarea id="questionsInput">What are the admission requirements?
How do I apply for financial aid?
What research opportunities are available?
Who should I contact about course registration?
What courses are required for the degree?</textarea>
                
                <label>Delay: <input type="number" id="delayInput" value="6" min="3" max="15"> seconds</label>
                
                <div class="status info" id="status">Ready to start testing</div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
                </div>
                
                <button onclick="startTesting()" id="startBtn">‚ñ∂Ô∏è Start Automated Test</button>
                <button onclick="stopTesting()" id="stopBtn" class="red" disabled>‚èπÔ∏è Stop Test</button>
                <button onclick="exportConversation()" id="exportBtn" class="orange" disabled>üíæ Export CSV</button>
                
                <label>Loaded Questions:</label>
                <div class="questions-list" id="questionsList">
                    Questions will appear here...
                </div>
            </div>
        </div>

        <!-- Middle Panel: Chatbot -->
        <div class="chatbot-panel">
            <div class="panel-header">üí¨ Chatbot Interface</div>
            <div id="chatbotContainer" style="height: calc(100% - 50px); position: relative;">
                <div class="embed-overlay" id="loadingOverlay">
                    <div>
                        <div>üîÑ Loading Chatbot...</div>
                        <div style="font-size: 12px; margin-top: 10px;">Please wait while the chatbot initializes</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Conversation Log -->
        <div class="panel">
            <div class="panel-header">üìã Live Conversation</div>
            <div class="panel-content">
                <div class="conversation" id="conversationLog">
                    <div class="message system">Conversation will appear here during testing...</div>
                </div>
                <button onclick="clearConversation()">üóëÔ∏è Clear Log</button>
                <button onclick="copyConversation()">üìã Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <!-- Load the same authentication script as the original chatbot -->
    <script src="https://aeroastrovfbot.netlify.app/index.js"></script>
    
    <script>
        let questions = [];
        let currentQuestionIndex = 0;
        let testingInterval = null;
        let conversation = [];
        let chatbotReady = false;

        // Initialize the page like the original chatbot
        function initializeChatbot() {
            // Use the same authentication logic as the original
            authenticateAndLoadChat().then(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
                chatbotReady = true;
                updateStatus('Chatbot ready for testing!', 'success');
                
                // Load initial questions
                loadQuestionsFromTextarea();
            }).catch(error => {
                document.getElementById('loadingOverlay').innerHTML = 
                    '<div style="color: red;">Error loading chatbot: ' + error.message + '</div>';
            });
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function addToConversation(message, type = 'system') {
            const log = document.getElementById('conversationLog');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${type}`;
            msgDiv.innerHTML = `${message}<br><small>${new Date().toLocaleTimeString()}</small>`;
            log.appendChild(msgDiv);
            log.scrollTop = log.scrollHeight;

            // Store for export
            conversation.push({
                message: message,
                type: type,
                timestamp: new Date().toISOString()
            });
        }

        async function loadFromGoogleSheets() {
            const sheetId = document.getElementById('googleSheetId').value.trim();
            if (!sheetId) {
                updateStatus('Please enter a Google Sheet ID', 'error');
                return;
            }

            const gid = document.getElementById('sheetGid').value.trim() || '0';
            
            updateStatus('Loading from Google Sheets...', 'warning');
            addToConversation(`üîÑ Loading questions from Google Sheet: ${sheetId}, GID: ${gid}`, 'system');

            try {
                const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
                
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await fetch(csvUrl, {
                    signal: controller.signal,
                    mode: 'cors',
                    headers: { 'Accept': 'text/csv, text/plain, */*' }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} - Make sure sheet is published and GID ${gid} exists`);
                }

                const csvText = await response.text();
                if (!csvText.trim()) {
                    throw new Error('Empty response from Google Sheets');
                }

                const lines = csvText.split('\n');
                const newQuestions = lines
                    .slice(1) // Skip header
                    .map(line => {
                        const firstComma = line.indexOf(',');
                        return firstComma === -1 ? line : line.substring(0, firstComma);
                    })
                    .filter(q => q && q.trim())
                    .map(q => q.replace(/"/g, '').trim());

                if (newQuestions.length === 0) {
                    throw new Error('No questions found in first column');
                }

                // Update the textarea with loaded questions
                document.getElementById('questionsInput').value = newQuestions.join('\n');
                
                questions = newQuestions;
                updateQuestionsList();
                updateProgress();
                updateStatus(`Loaded ${questions.length} questions from Google Sheets`, 'success');
                addToConversation(`‚úÖ Successfully loaded ${questions.length} questions from Google Sheets`, 'system');

            } catch (error) {
                let errorMsg = error.message;
                if (error.name === 'AbortError') {
                    errorMsg = 'Request timed out after 10 seconds';
                }
                
                updateStatus(`Google Sheets error: ${errorMsg}`, 'error');
                addToConversation(`‚ùå Google Sheets failed: ${errorMsg}`, 'system');
                addToConversation(`üí° Try: 1) Publish sheet to web, 2) Check GID, 3) Use manual entry`, 'system');
            }
        }
            const defaultQuestions = [
                "What are the admission requirements?",
                "How do I apply for financial aid?",
                "What research opportunities are available?",
                "Who should I contact about course registration?",
                "What courses are required for the aerospace engineering degree?",
                "What is the application deadline?",
                "How do I schedule a campus visit?",
                "What scholarships are available?",
                "Tell me about the faculty research areas",
                "What are the prerequisites for graduate programs?"
            ];
            
            document.getElementById('questionsInput').value = defaultQuestions.join('\\n');
            loadQuestionsFromTextarea();
        }

        function loadQuestionsFromTextarea() {
            const textarea = document.getElementById('questionsInput');
            const newQuestions = textarea.value.split('\\n').filter(q => q.trim());
            
            if (newQuestions.length === 0) {
                updateStatus('Please enter some questions', 'error');
                return;
            }
            
            questions = newQuestions;
            updateQuestionsList();
            updateProgress();
            updateStatus(`Loaded ${questions.length} questions`, 'success');
        }

        function updateQuestionsList() {
            const list = document.getElementById('questionsList');
            if (questions.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #6c757d;">No questions loaded</div>';
                return;
            }

            list.innerHTML = questions.map((q, index) => {
                let className = 'question-item';
                if (index < currentQuestionIndex) className += ' completed';
                else if (index === currentQuestionIndex) className += ' current';
                
                return `<div class="${className}">${index + 1}. ${q}</div>`;
            }).join('');
        }

        function updateProgress() {
            const progressBar = document.getElementById('progressBar');
            const percentage = questions.length > 0 ? (currentQuestionIndex / questions.length) * 100 : 0;
            progressBar.style.width = percentage + '%';
            progressBar.textContent = `${Math.round(percentage)}% (${currentQuestionIndex}/${questions.length})`;
        }

        async function startTesting() {
            if (!chatbotReady) {
                updateStatus('Chatbot not ready yet', 'error');
                return;
            }

            if (questions.length === 0) {
                loadQuestionsFromTextarea();
                if (questions.length === 0) {
                    updateStatus('Please enter some questions first', 'error');
                    return;
                }
            }

            const delay = parseInt(document.getElementById('delayInput').value) * 1000;
            currentQuestionIndex = 0;

            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            updateStatus('Testing in progress...', 'warning');
            addToConversation(`üöÄ Starting automated test with ${questions.length} questions`, 'system');
            
            // Start the testing loop
            await sendNextQuestion();
            testingInterval = setInterval(sendNextQuestion, delay);
        }

        async function sendNextQuestion() {
            if (currentQuestionIndex >= questions.length) {
                stopTesting();
                updateStatus('All questions completed!', 'success');
                addToConversation('‚úÖ All questions completed!', 'system');
                document.getElementById('exportBtn').disabled = false;
                return;
            }

            const question = questions[currentQuestionIndex];
            const questionNum = currentQuestionIndex + 1;

            addToConversation(`Q${questionNum}: ${question}`, 'user');
            
            try {
                // Send question using Voiceflow's interact method
                if (window.voiceflow && window.voiceflow.chat && window.voiceflow.chat.interact) {
                    window.voiceflow.chat.interact({
                        type: 'text',
                        payload: question
                    });

                    // Wait a moment then try to capture the response
                    setTimeout(() => {
                        const response = captureLatestResponse();
                        addToConversation(`A${questionNum}: ${response}`, 'bot');
                    }, 3000);

                } else {
                    addToConversation('Error: Voiceflow not accessible', 'system');
                }

            } catch (error) {
                addToConversation(`Error sending question: ${error.message}`, 'system');
            }

            currentQuestionIndex++;
            updateProgress();
            updateQuestionsList();
        }

        function captureLatestResponse() {
            try {
                // Try to access Voiceflow's shadow DOM
                if (window.voiceflow && window.voiceflow.chat && window.voiceflow.chat._shadowRoot) {
                    const shadowRoot = window.voiceflow.chat._shadowRoot;
                    
                    // Look for bot message elements
                    const selectors = [
                        '.vfrc-message--assistant:last-child',
                        '.bot-message:last-child',
                        '[data-role="assistant"]:last-child',
                        '.vfrc-chat-response:last-child'
                    ];
                    
                    for (const selector of selectors) {
                        const element = shadowRoot.querySelector(selector);
                        if (element) {
                            const text = element.textContent || element.innerText;
                            if (text && text.trim()) {
                                return text.trim();
                            }
                        }
                    }
                }
                
                return 'Response received (content not fully accessible)';
                
            } catch (error) {
                return 'Response received (capture failed)';
            }
        }

        function stopTesting() {
            if (testingInterval) {
                clearInterval(testingInterval);
                testingInterval = null;
            }
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            updateStatus('Testing stopped', 'info');
            addToConversation('‚èπÔ∏è Testing stopped', 'system');
            
            if (conversation.length > 2) {
                document.getElementById('exportBtn').disabled = false;
            }
        }

        function exportConversation() {
            if (conversation.length === 0) {
                updateStatus('No conversation to export', 'error');
                return;
            }

            // Create CSV with questions and answers paired
            const csvData = [];
            let currentQ = '';
            let currentA = '';

            conversation.forEach(item => {
                if (item.type === 'user' && item.message.startsWith('Q')) {
                    if (currentQ && currentA) {
                        csvData.push({ question: currentQ, answer: currentA, timestamp: item.timestamp });
                    }
                    currentQ = item.message.replace(/^Q\\d+:\\s*/, '');
                    currentA = '';
                } else if (item.type === 'bot' && item.message.startsWith('A')) {
                    currentA = item.message.replace(/^A\\d+:\\s*/, '');
                }
            });

            // Don't forget the last pair
            if (currentQ && currentA) {
                csvData.push({ question: currentQ, answer: currentA, timestamp: new Date().toISOString() });
            }

            const csv = [
                'Question,Answer,Timestamp',
                ...csvData.map(row => 
                    `"${row.question.replace(/"/g, '""')}","${row.answer.replace(/"/g, '""')}","${row.timestamp}"`
                )
            ].join('\\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chatbot-conversation-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            updateStatus('Conversation exported to CSV', 'success');
        }

        function clearConversation() {
            document.getElementById('conversationLog').innerHTML = 
                '<div class="message system">Conversation cleared...</div>';
            conversation = [];
            document.getElementById('exportBtn').disabled = true;
        }

        function copyConversation() {
            const text = conversation.map(item => 
                `[${item.type.toUpperCase()}] ${item.message}`
            ).join('\\n');
            
            navigator.clipboard.writeText(text).then(() => {
                updateStatus('Conversation copied to clipboard', 'success');
            });
        }

        // Initialize when page loads
        window.addEventListener('load', () => {
            updateStatus('Initializing chatbot...', 'warning');
            
            // Load the Voiceflow widget
            (function(d, t) {
                var v = d.createElement(t), s = d.getElementsByTagName(t)[0];
                v.onload = function() {
                    // Initialize the chatbot after a delay
                    setTimeout(initializeChatbot, 3000);
                }
                v.src = "https://cdn.voiceflow.com/widget/bundle.mjs"; 
                v.type = "text/javascript"; 
                s.parentNode.insertBefore(v, s);
            })(document, 'script');
        });

        // Update questions when textarea changes
        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('questionsInput');
            if (textarea) {
                textarea.addEventListener('input', loadQuestionsFromTextarea);
            }
        });
    </script>
</body>
</html>
